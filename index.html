
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horizon AI - Your Learning Navigator</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Space+Grotesk:wght@500;700&family=Orbitron:wght@700&family=Cutive+Mono&display=swap" rel="stylesheet">
    
    <!-- Ionicons for UI icons -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- UI Redesign & Animations --- */
        :root {
            --primary-glow: #00c6ff;
            --secondary-glow: #0072ff;
            --accent-color: #f59e0b; /* amber-500 */
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0a09; /* gray-950 */
            color: #f2f2f2;
            overflow-x: hidden;
        }

        /* --- Aurora Background Effect --- */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 15% 25%, var(--primary-glow), transparent 30%),
                radial-gradient(circle at 85% 75%, var(--secondary-glow), transparent 40%);
            filter: blur(100px);
            opacity: 0.3;
            z-index: -2;
            animation: aurora-flow 20s infinite alternate ease-in-out;
        }

        @keyframes aurora-flow {
            from { transform: rotate(0deg) scale(1.2); }
            to { transform: rotate(360deg) scale(1.5); }
        }

        /* --- Background Emoji Animation --- */
        #background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .shape {
            position: absolute;
            animation: float 30s infinite ease-in-out;
            user-select: none;
            opacity: 0.1;
        }

        @keyframes float {
            0% { transform: translateY(5vh) rotate(0deg); }
            50% { transform: translateY(-100vh) rotate(360deg); }
            100% { transform: translateY(5vh) rotate(720deg); }
        }

        /* --- Intro Animation --- */
        #intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0c0a09;
            z-index: 100;
            display: flex;
            flex-direction: column; /* Changed for subtitle */
            justify-content: center;
            align-items: center;
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }

        #intro-overlay.hidden {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        .intro-text {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem;
            color: white;
            font-weight: 700;
            letter-spacing: 2px;
        }
        .intro-text span, .intro-subtext span { /* Combined span styles */
            display: inline-block;
            opacity: 0;
            animation: fadeIn-slideUp 0.8s ease-out forwards;
        }
        /* Subtitle style */
        .intro-subtext {
            font-family: 'Inter', sans-serif;
            font-size: 1.1rem;
            color: #a1a1aa; /* zinc-400 */
            font-weight: 500;
            letter-spacing: 1px;
            margin-top: 0.5rem;
        }

        @keyframes fadeIn-slideUp {
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Glassmorphism Card Style --- */
        .glass-card {
            background: rgba(20, 20, 22, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* --- Button Redesign --- */
        .dynamic-button {
            background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow));
            border: none;
            border-radius: 9999px; /* pill shape */
            padding: 0.75rem 2.5rem;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            color: white;
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.4), 0 0 25px rgba(0, 114, 255, 0.3);
            transition: all 0.3s ease;
        }
        .dynamic-button:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 0 25px rgba(0, 198, 255, 0.6), 0 0 40px rgba(0, 114, 255, 0.5);
        }
        .dynamic-button:disabled {
            filter: grayscale(80%);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .secondary-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1.5rem;
        }
        .secondary-button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: none;
            transform: translateY(-2px);
        }

        .ai-feature-btn {
            background: linear-gradient(90deg, #4f46e5, #a21caf);
            border-radius: 0.75rem;
            padding: 0.6rem 1.2rem;
        }
        .ai-feature-btn:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.6), 0 0 30px rgba(162, 28, 175, 0.5);
        }


        /* --- Timeline for Roadmap --- */
        .timeline-container {
            position: relative;
            padding-left: 2.5rem; /* Space for the line */
        }
        .timeline-container::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 1rem;
            bottom: 1rem;
            width: 3px;
            background: linear-gradient(to bottom, var(--primary-glow), var(--secondary-glow));
            border-radius: 2px;
        }
        .timeline-item {
            position: relative;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2.2rem;
            top: 0.6rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background-color: #0c0a09;
            border: 3px solid var(--primary-glow);
            z-index: 1;
            transition: all 0.3s ease;
        }
        .timeline-item:hover::before {
            transform: scale(1.2);
            background-color: var(--primary-glow);
        }

        .toggle-resources-btn.open ion-icon {
            transform: rotate(180deg);
        }

        /* General Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-on-load {
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        /* --- AI Coach Chat Styles --- */
        #ai-coach-chat-modal-content, #debate-modal-content {
            display: flex;
            flex-direction: column;
            height: 80vh;
            max-height: 600px;
        }
        #chat-messages, #debate-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .chat-message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }
        .chat-message.user {
            align-items: flex-end;
        }
        .chat-message.model {
            align-items: flex-start;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            word-wrap: break-word;
        }
        .chat-bubble.user {
            background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow));
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-bubble.model {
            background-color: #27272a; /* zinc-800 */
            color: #e4e4e7; /* zinc-200 */
            border-bottom-left-radius: 0.25rem;
        }
        .chat-bubble.debate-antagonist {
            background-color: #581c87; /* purple-900 */
            border-bottom-left-radius: 0.25rem;
        }

        /* --- AI Coach FAB --- */
        #ai-coach-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem; /* Changed from left to right */
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow));
            box-shadow: 0 0 25px rgba(0, 198, 255, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150;
            border: none;
            cursor: pointer;
            transition: all 0.4s ease-in-out;
            transform: translateY(150px) scale(0.5);
            opacity: 0;
            pointer-events: none;
        }
        #ai-coach-fab.visible {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        #ai-coach-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 0 35px rgba(0, 198, 255, 0.8);
        }
        #ai-coach-fab span {
            font-size: 2rem;
            transition: transform 0.3s ease;
        }
        #ai-coach-fab:hover span {
            transform: rotate(20deg) scale(1.1);
        }

        /* --- Quiz Styles --- */
        .quiz-option {
            display: block;
            padding: 0.75rem 1.25rem;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.875rem;
        }
        .quiz-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-glow);
        }
        .quiz-option.selected {
            background-color: var(--primary-glow);
            color: black;
            border-color: var(--primary-glow);
        }
        .quiz-option.correct {
            background-color: #166534; /* green-800 */
            border-color: #22c55e; /* green-500 */
        }
        .quiz-option.incorrect {
            background-color: #991b1b; /* red-800 */
            border-color: #ef4444; /* red-500 */
        }

        /* --- Learning Style Radio --- */
        .learning-style-label {
            display: inline-block;
            padding: 0.5rem 1rem;
            border: 1px solid #404040; /* zinc-700 */
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.875rem;
        }
        .learning-style-radio:checked + .learning-style-label {
            background-color: var(--primary-glow);
            border-color: var(--primary-glow);
            color: #0c0a09;
            font-weight: 600;
        }
        
        /* --- Flashcard Styles --- */
        .flashcard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        .flashcard {
            perspective: 1000px;
            cursor: pointer;
            height: 150px;
        }
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard.is-flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        .flashcard-front {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }
        .flashcard-back {
            background: var(--primary-glow);
            color: #0c0a09;
            transform: rotateY(180deg);
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="text-gray-200">

    <!-- Intro Animation Overlay -->
    <div id="intro-overlay">
        <div class="text-center">
            <h1 class="intro-text">
                <span style="animation-delay: 0.2s; transform: translateY(20px);">H</span>
                <span style="animation-delay: 0.3s; transform: translateY(20px);">o</span>
                <span style="animation-delay: 0.4s; transform: translateY(20px);">r</span>
                <span style="animation-delay: 0.5s; transform: translateY(20px);">i</span>
                <span style="animation-delay: 0.6s; transform: translateY(20px);">z</span>
                <span style="animation-delay: 0.7s; transform: translateY(20px);">o</span>
                <span style="animation-delay: 0.8s; transform: translateY(20px);">n</span>
                <span style="animation-delay: 1.0s; transform: translateY(20px);">&nbsp;</span>
                <span style="animation-delay: 1.1s; transform: translateY(20px);">A</span>
                <span style="animation-delay: 1.2s; transform: translateY(20px);">I</span>
            </h1>
            <p class="intro-subtext">
                <span style="animation-delay: 1.4s; transform: translateY(20px);">Your&nbsp;</span>
                <span style="animation-delay: 1.5s; transform: translateY(20px);">personal&nbsp;</span>
                <span style="animation-delay: 1.6s; transform: translateY(20px);">AI&nbsp;</span>
                <span style="animation-delay: 1.7s; transform: translateY(20px);">learning&nbsp;</span>
                <span style="animation-delay: 1.8s; transform: translateY(20px);">navigator.</span>
            </p>
        </div>
    </div>

    <div id="background-animation"></div>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl min-h-screen relative z-10 hidden" id="main-content">
        <!-- Header Section -->
        <header class="text-center p-6 mb-8 animate-on-load" style="animation-delay: 0.2s;">
            <h1 class="text-5xl md:text-6xl font-bold text-white" style="font-family: 'Space Grotesk', sans-serif; text-shadow: 0 0 15px rgba(255,255,255,0.3);">
                Horizon AI
            </h1>
            <p class="mt-4 text-lg text-gray-400">
                Chart your course to new skills. Your personal AI learning navigator.
            </p>
        </header>

        <div>
            <!-- Input Form Section -->
            <section id="input-section" class="glass-card p-6 md:p-8 mb-8 animate-on-load" style="animation-delay: 0.4s;">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="skills-input" class="block text-sm font-medium text-gray-300 mb-2">My Current Skills</label>
                        <input id="skills-input" type="text" placeholder="e.g., Python, public speaking" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition text-white placeholder-gray-500"/>
                        <div class="mt-2 text-xs text-gray-500 h-4">e.g., <span id="skills-example" class="transition-opacity duration-500 ease-in-out"></span></div>
                    </div>
                    <div>
                        <label for="interests-input" class="block text-sm font-medium text-gray-300 mb-2">My Interests</label>
                        <input id="interests-input" type="text" placeholder="e.g., video games, ancient history" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition text-white placeholder-gray-500"/>
                        <div class="mt-2 text-xs text-gray-500 h-4">e.g., <span id="interests-example" class="transition-opacity duration-500 ease-in-out"></span></div>
                            <button id="interest-quiz-btn" class="dynamic-button secondary-button !text-xs !px-4 !py-2 mt-2">Stuck? Take a quiz to find your interests!</button>
                    </div>
                </div>
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-300 mb-3 text-center">My Preferred Learning Style</label>
                    <div id="learning-style-selector" class="flex flex-wrap justify-center gap-3">
                        <input type="radio" id="style-balanced" name="learning-style" value="Balanced" class="hidden learning-style-radio" checked>
                        <label for="style-balanced" class="learning-style-label">Balanced</label>

                        <input type="radio" id="style-visual" name="learning-style" value="Visual" class="hidden learning-style-radio">
                        <label for="style-visual" class="learning-style-label">Visual (Videos, Diagrams)</label>
                        
                        <input type="radio" id="style-practical" name="learning-style" value="Practical" class="hidden learning-style-radio">
                        <label for="style-practical" class="learning-style-label">Practical (Hands-on)</label>

                        <input type="radio" id="style-theoretical" name="learning-style" value="Theoretical" class="hidden learning-style-radio">
                        <label for="style-theoretical" class="learning-style-label">Theoretical (Reading)</label>
                    </div>
                    <div class="text-center mt-3">
                        <button id="learning-style-analyzer-btn" class="dynamic-button secondary-button !text-xs !px-4 !py-2">Not sure? Analyze My Style!</button>
                    </div>
                </div>

                <!-- UPDATED SECTION for pursuing class -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-300 mb-3 text-center">My Current Academic Level</label>
                    <div id="pursuing-selector" class="flex flex-wrap justify-center gap-3">
                        <input type="radio" id="pursuing-10" name="pursuing-class" value="Class 10" class="hidden learning-style-radio">
                        <label for="pursuing-10" class="learning-style-label">Class 10</label>

                        <input type="radio" id="pursuing-12" name="pursuing-class" value="Class 12" class="hidden learning-style-radio">
                        <label for="pursuing-12" class="learning-style-label">Class 12</label>
                        
                        <input type="radio" id="pursuing-grad" name="pursuing-class" value="Graduation" class="hidden learning-style-radio" checked>
                        <label for="pursuing-grad" class="learning-style-label">Graduation</label>
                    </div>
                </div>

                <!-- UPDATED CONDITIONAL SECTION FOR STREAM -->
                <div id="stream-selection-section" class="mt-6">
                        <label class="block text-sm font-medium text-gray-300 mb-3 text-center">My Field / Stream</label>
                        <div id="stream-selector" class="flex flex-wrap justify-center gap-3">
                            <!-- Stream options will be populated by JS -->
                        </div>
                </div>

                <div class="mt-8 text-center">
                    <button id="get-suggestions-btn" class="dynamic-button">
                        Discover My Path
                    </button>
                </div>
            </section>
            
            <!-- Error Display Area -->
            <div id="error-display" class="hidden glass-card bg-red-900/50 border-red-500 text-red-300 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline" id="error-message"></span>
            </div>

            <!-- Results Display Area -->
            <div id="results-area" class="space-y-8">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Generic Feature Modal Structure -->
    <div id="feature-modal-overlay" class="modal-overlay">
        <div id="feature-modal-content" class="modal-content glass-card p-6 md:p-8">
            <!-- Feature content injected by JS -->
        </div>
    </div>

    <!-- AI Coach Chat Modal Structure -->
    <div id="ai-coach-chat-modal-overlay" class="modal-overlay">
        <div id="ai-coach-chat-modal-content" class="modal-content glass-card p-0">
               <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                   <h2 id="chat-header" class="text-xl font-bold text-white text-center" style="font-family: 'Orbitron', sans-serif;">AI Learning Coach</h2>
                   <button id="close-chat-btn" class="text-gray-400 hover:text-white transition-colors">
                       <ion-icon name="close-circle-outline" class="text-2xl"></ion-icon>
                   </button>
               </div>
               <div id="chat-messages" class="flex-grow p-4 overflow-y-auto">
                   <!-- Chat messages will be injected here -->
               </div>
               <div class="p-4 border-t border-gray-700">
                   <form id="chat-form" class="flex gap-2">
                       <input id="chat-input" type="text" placeholder="Ask a question..." class="flex-grow px-4 py-2 bg-gray-800/50 border border-gray-600 rounded-full focus:ring-2 focus:ring-blue-400 focus:border-transparent transition text-white placeholder-gray-500" autocomplete="off">
                       <button type="submit" id="chat-send-btn" class="dynamic-button !p-3 !rounded-full flex items-center justify-center">
                           <ion-icon name="send-outline" class="text-xl"></ion-icon>
                       </button>
                   </form>
               </div>
        </div>
    </div>

      <!-- DEBATE MODAL -->
    <div id="debate-modal-overlay" class="modal-overlay">
        <div id="debate-modal-content" class="modal-content glass-card p-0">
            <!-- Debate content injected by JS -->
        </div>
    </div>

    <!-- AI Coach Floating Action Button -->
    <button id="ai-coach-fab">
        <span>ðŸ’¬</span>
    </button>


    <script>
        const apiKey1 = "AIzaSyCrG9Mqb2iIsXsqkHob4CsgOYyylueC-m4"; // Primary key for roadmap generation
        const apiKey2 = "AIzaSyCrG9Mqb2iIsXsqkHob4CsgOYyylueC-m4"; // Background processing key for all AI features
        const newsApiKey = "6021fc73-378f-4f4a-9606-039bb2d80c8c"; // Newsdata.io API key
        
        // Two separate API URLs for perfect background fetch
        const roadmapApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/"; // For roadmap with apiKey1
        const aiFeaturesApiUrl = "https://generativelanguage.googleapis.com/v1beta/models/"; // For AI features with apiKey2
        
        // Always use apiKey2 for background features
        function getBackgroundApiKey() {
            return apiKey2;
        }
        
        // Prefetch cache for instant feature loading
        const prefetchCache = {
            setupGuide: null,
            deepDive: null,
            careerExplorer: null,
            projectSuggestions: null,
            studyPlan: null,
            flashcards: null,
            quiz: null,
            mockInterview: null,
            careerRecommendation: null,
            offlineCenters: null,
            eli5: null,
            realWorldScenario: null,
            debateTopic: null,
            toughnessCalculator: null,
            timelineTracker: null,
            academicTimeline: null
        };
        let isPrefetching = false;

        document.addEventListener('DOMContentLoaded', () => {
            // --- Intro Animation Logic ---
            const introOverlay = document.getElementById('intro-overlay');
            const mainContent = document.getElementById('main-content');
            setTimeout(() => {
                introOverlay.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }, 3000); // Increased duration for subtitle

            generateBackgroundShapes();
            rotateExamples();
            setInterval(rotateExamples, 5000);

            // --- Button Font Rotation Logic ---
            const getSuggestionsBtn = document.getElementById('get-suggestions-btn');
            const buttonFonts = [
                "'Space Grotesk', sans-serif",
                "'Orbitron', sans-serif",
                "'Inter', sans-serif",
                "'Cutive Mono', monospace"
            ];
            let currentFontIndex = 0;

            setInterval(() => {
                if (getSuggestionsBtn) {
                    currentFontIndex = (currentFontIndex + 1) % buttonFonts.length;
                    getSuggestionsBtn.style.fontFamily = buttonFonts[currentFontIndex];
                }
            }, 3000); // Change font every 3 seconds

            // --- Pursuing Class Logic ---
            const pursuingSelector = document.getElementById('pursuing-selector');
            const streamSelectionSection = document.getElementById('stream-selection-section');
            const streamSelector = document.getElementById('stream-selector');

            function updateStreamOptions(selectedClass) {
                streamSelectionSection.classList.remove('hidden');
                if (selectedClass === 'Class 12') {
                    streamSelector.innerHTML = `
                        <input type="radio" id="stream-science" name="stream" value="Science" class="hidden learning-style-radio" checked>
                        <label for="stream-science" class="learning-style-label">Science</label>

                        <input type="radio" id="stream-commerce" name="stream" value="Commerce" class="hidden learning-style-radio">
                        <label for="stream-commerce" class="learning-style-label">Commerce</label>

                        <input type="radio" id="stream-biology" name="stream" value="Biology" class="hidden learning-style-radio">
                        <label for="stream-biology" class="learning-style-label">Biology</label>
                    `;
                } else if (selectedClass === 'Class 10') {
                    streamSelector.innerHTML = `
                        <input type="radio" id="stream-general" name="stream" value="General" class="hidden learning-style-radio" checked>
                        <label for="stream-general" class="learning-style-label">General</label>
                    `;
                } else { // Graduation
                        streamSelector.innerHTML = `
                        <input type="radio" id="stream-eng" name="stream" value="Engineering" class="hidden learning-style-radio" checked>
                        <label for="stream-eng" class="learning-style-label">Engineering</label>
                        <input type="radio" id="stream-sci" name="stream" value="Science" class="hidden learning-style-radio">
                        <label for="stream-sci" class="learning-style-label">Science</label>
                        <input type="radio" id="stream-com" name="stream" value="Commerce" class="hidden learning-style-radio">
                        <label for="stream-com" class="learning-style-label">Commerce</label>
                        <input type="radio" id="stream-art" name="stream" value="Arts" class="hidden learning-style-radio">
                        <label for="stream-art" class="learning-style-label">Arts</label>
                        <input type="radio" id="stream-med" name="stream" value="Medical" class="hidden learning-style-radio">
                        <label for="stream-med" class="learning-style-label">Medical</label>
                    `;
                }
            }

            pursuingSelector.addEventListener('change', (event) => {
                updateStreamOptions(event.target.value);
            });
            
            // Set initial state on load
            const initialClass = document.querySelector('input[name="pursuing-class"]:checked').value;
            updateStreamOptions(initialClass);
        });

        /**
         * Generates and places floating emoji shapes in the background.
         */
        function generateBackgroundShapes() {
            const container = document.getElementById('background-animation');
            if (!container) return;
            container.innerHTML = '';
            const shapeCount = 15;
            const emojis = ['ðŸ“–', 'ðŸ’¡', 'âœ¨', 'ðŸ§ ', 'ðŸ“ˆ', 'ðŸŽ¨', 'ðŸ’»', 'ðŸ”¬'];
            for (let i = 0; i < shapeCount; i++) {
                const shape = document.createElement('div');
                shape.classList.add('shape');
                shape.innerHTML = emojis[Math.floor(Math.random() * emojis.length)];
                const size = Math.random() * 50 + 20;
                shape.style.fontSize = `${size}px`;
                shape.style.left = `${Math.random() * 100}%`;
                shape.style.bottom = `-${size}px`;
                shape.style.animationDelay = `${Math.random() * 20}s`;
                shape.style.animationDuration = `${Math.random() * 20 + 25}s`;
                container.appendChild(shape);
            }
        }
        
        const skillExamples = ["baking sourdough", "graphic design", "playing guitar", "data analysis with Python", "calligraphy"];
        const interestExamples = ["true crime podcasts", "sci-fi movies", "mountain hiking", "competitive gaming", "classic literature"];
        let skillIndex = 0;
        let interestIndex = 0;

        /**
         * Rotates through example text for the input fields.
         */
        function rotateExamples() {
            const skillsExampleEl = document.getElementById('skills-example');
            const interestsExampleEl = document.getElementById('interests-example');
            if (!skillsExampleEl || !interestsExampleEl) return;
            skillsExampleEl.style.opacity = '0';
            interestsExampleEl.style.opacity = '0';
            setTimeout(() => {
                skillIndex = (skillIndex + 1) % skillExamples.length;
                interestIndex = (interestIndex + 1) % interestExamples.length;
                skillsExampleEl.textContent = skillExamples[skillIndex];
                interestsExampleEl.textContent = interestExamples[interestIndex];
                skillsExampleEl.style.opacity = '1';
                interestsExampleEl.style.opacity = '1';
            }, 500);
        }

        // Global error handler to catch and log errors gracefully
        window.addEventListener('error', function(event) {
            // Suppress non-critical errors from external scripts
            if (event.message && (
                event.message.includes('Chart') || 
                event.message.includes('ion-icon') ||
                event.message.includes('ResizeObserver')
            )) {
                event.preventDefault();
                return;
            }
            console.error('ðŸš¨ Global error caught:', event.error || event.message);
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('ðŸš¨ Unhandled promise rejection:', event.reason);
            event.preventDefault();
        });

        const skillsInput = document.getElementById('skills-input');
        const interestsInput = document.getElementById('interests-input');
        const getSuggestionsBtn = document.getElementById('get-suggestions-btn');
        const resultsArea = document.getElementById('results-area');
        const errorDisplay = document.getElementById('error-display');
        const errorMessage = document.getElementById('error-message');
        const featureModalOverlay = document.getElementById('feature-modal-overlay');
        const featureModalContent = document.getElementById('feature-modal-content');
        const aiCoachChatModalOverlay = document.getElementById('ai-coach-chat-modal-overlay');
        const debateModalOverlay = document.getElementById('debate-modal-overlay');
        const aiCoachFab = document.getElementById('ai-coach-fab');
        const interestQuizBtn = document.getElementById('interest-quiz-btn');

        let selectedSkill = ''; // To store the skill name between steps
        let selectedWeeks = '';
        let selectedLevel = '';
        let chatHistory = []; // To store the AI coach conversation
        let debateHistory = []; // To store the debate conversation
        let roadmapData = null; // To store the current roadmap
        let currentSetupSteps = [];
        let currentStepIndex = 0;
        let currentNarration = null; // To hold the current audio object
        let currentInterviewQuestions = [];
        let currentInterviewQuestionIndex = 0;
        let styleAnalyzerQuestions = [];
        let styleAnalyzerAnswers = [];
        let currentStyleAnalyzerQuestionIndex = 0;
        let jobTrendChart = null; // To hold the chart instance
        let currentNews = []; // To hold current news articles

        /**
         * Displays an error message to the user.
         * @param {string} message The error message to display.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorDisplay.classList.remove('hidden');
            errorDisplay.style.animation = 'fadeIn 0.5s ease-out forwards';
        }

        /**
         * Clears the current error message.
         */
        function clearError() {
            errorDisplay.classList.add('hidden');
        }

        /**
         * Shows a loading spinner and message.
         * @param {string} message The message to show with the loader.
         * @param {HTMLElement} container The container to place the loader in.
         */
        function showLoader(message, container = resultsArea) {
            const loaderHtml = `
                <div class="text-center p-8 glass-card animate-on-load">
                    <div class="flex justify-center items-center">
                        <div class="w-8 h-8 border-4 border-dashed rounded-full animate-spin" style="border-top-color: var(--primary-glow); border-left-color: var(--primary-glow); border-right-color: transparent; border-bottom-color: transparent;"></div>
                    </div>
                    <p class="mt-4 text-gray-300 font-medium">${message}</p>
                </div>
            `;
            container.innerHTML = loaderHtml;
        }
        
        /**
         * Resets the UI to the initial state.
         */
        function resetUI() {
            resultsArea.innerHTML = '';
            clearError();
            skillsInput.value = '';
            interestsInput.value = '';
            selectedSkill = '';
            selectedWeeks = '';
            selectedLevel = '';
            roadmapData = null;
            isPrefetching = false;
            
            // Clear prefetch cache
            Object.keys(prefetchCache).forEach(key => {
                prefetchCache[key] = null;
            });
            
            document.getElementById('input-section').classList.remove('hidden');
            document.getElementById('input-section').scrollIntoView({ behavior: 'smooth' });
            getSuggestionsBtn.disabled = false;
            getSuggestionsBtn.textContent = 'Discover My Path';
            aiCoachFab.classList.remove('visible');
            if (jobTrendChart) {
                jobTrendChart.destroy();
                jobTrendChart = null;
            }
        }
        
        /**
         * Generic function to make Gemini API calls.
         * @param {string} model The model to use.
         * @param {object} payload The API request payload.
         * @param {number} retryCount The current retry count.
         * @param {string} apiKey The API key to use for this request.
         * @returns {Promise<any>} The API response.
         */
        async function fetchFromGeminiApi(model, payload, apiKey, retryCount = 0) {
            if (!apiKey || apiKey === "YOUR_GEMINI_API_KEY") {
                throw new Error("A valid Gemini API key is not configured. Please add it to the `geminiApiKeys` array.");
            }
            
            // Use different API URL based on which key is being used
            const baseUrl = (apiKey === apiKey1) ? roadmapApiUrl : aiFeaturesApiUrl;
            const apiUrl = `${baseUrl}${model}:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Gemini API Error: ${response.status} - ${JSON.stringify(errorData)}`);
                }
                const result = await response.json();
                
                // Check if the response was blocked
                if (result.candidates && result.candidates[0]?.finishReason === "SAFETY") {
                    throw new Error("The request was blocked due to safety settings. Please adjust your input and try again.");
                }

                return result;

            } catch (err) {
                 if (retryCount < 3) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(res => setTimeout(res, delay));
                    return fetchFromGeminiApi(model, payload, apiKey, retryCount + 1);
                } else {
                    throw new Error("The Gemini API request failed after multiple retries. The service may be temporarily unavailable.");
                }
            }
        }


        /**
         * Handles the initial request for skill suggestions.
         */
        async function handleGetSuggestions() {
            clearError();
            const skills = skillsInput.value.trim();
            const interests = interestsInput.value.trim();
            if (!skills || !interests) {
                showError("Please enter both your current skills and interests.");
                return;
            }

            const pursuingClassInput = document.querySelector('input[name="pursuing-class"]:checked');
            const pursuingClass = pursuingClassInput ? pursuingClassInput.value : 'Graduation';
            
            const streamInput = document.querySelector('input[name="stream"]:checked');
            const stream = streamInput ? streamInput.value : 'N/A';

            getSuggestionsBtn.disabled = true;
            getSuggestionsBtn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-dashed rounded-full animate-spin mx-auto"></div>';
            showLoader("Analyzing your profile...");
            
            const prompt = `
                You are an expert career and learning advisor. A user is in '${pursuingClass}' with a focus on the '${stream}' stream.
                Their current skills are: '${skills}'.
                Their interests are: '${interests}'.

                Based on this profile, suggest 6 unique and interesting new skills. Each suggestion must be a creative synthesis of their skills and interests.
                For each suggestion, provide a 'name' (the skill) and a short, compelling 'description' (1-2 sentences) explaining why it's a perfect fit for this specific user profile.
                Provide the data as a JSON object with a 'suggestions' array.
            `;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            suggestions: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        description: { type: "STRING" }
                                    },
                                    required: ["name", "description"]
                                }
                            }
                        },
                        required: ["suggestions"]
                    }
                }
            };
            
            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey1); // Use primary key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                displaySuggestions(data.suggestions);
            } catch (err) {
                showError(err.message);
                resultsArea.innerHTML = '';
            } finally {
                getSuggestionsBtn.disabled = false;
                getSuggestionsBtn.textContent = 'Discover My Path';
            }
        }

        /**
         * Renders the suggested skills cards.
         * @param {Array<object>} suggestions An array of skill suggestions.
         */
        function displaySuggestions(suggestions) {
            if (!suggestions || suggestions.length === 0) {
                showError("Couldn't find any suggestions. Try being more specific!");
                resultsArea.innerHTML = '';
                return;
            }
            let suggestionsHtml = `
                <div id="suggestions-container" class="animate-on-load" style="animation-delay: 0.1s;">
                    <h2 class="text-3xl font-bold text-white mb-6 text-center" style="font-family: 'Space Grotesk', sans-serif;">Your Next Adventure Awaits...</h2>
                    <div id="suggestion-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            `;
            suggestions.forEach((suggestion, index) => {
                suggestionsHtml += `
                            <div class="suggestion-card glass-card p-6 cursor-pointer transition-all duration-300 hover:border-blue-400 hover:-translate-y-2" data-skill-name="${suggestion.name}" style="animation: fadeIn 0.5s ease-out forwards; animation-delay: ${0.2 + index * 0.15}s; opacity: 0;">
                                <h3 class="text-xl font-bold text-white pointer-events-none" style="font-family: 'Space Grotesk', sans-serif;">${suggestion.name}</h3>
                                <p class="text-gray-400 mt-2 pointer-events-none">${suggestion.description}</p>
                            </div>
                `;
            });
            suggestionsHtml += `</div>
                    <div class="text-center mt-8">
                        <button id="refresh-suggestions-btn" class="dynamic-button secondary-button inline-flex items-center animate-on-load" style="animation-delay: 1.1s">
                            <ion-icon name="refresh-outline" class="text-xl mr-2"></ion-icon>
                            Refresh Suggestions
                        </button>
                    </div>
                </div>`;
            
            suggestionsHtml += `
                <div id="time-plan-section" class="hidden animate-on-load glass-card p-6 md:p-8 mt-8">
                    <h3 class="text-2xl font-bold text-center text-white mb-6" style="font-family: 'Space Grotesk', sans-serif;">Choose Your Learning Pace</h3>
                    <div class="flex flex-wrap justify-center gap-4">
                        <button class="time-plan-btn dynamic-button" data-weeks="4">4 Weeks</button>
                        <button class="time-plan-btn dynamic-button" data-weeks="6">6 Weeks</button>
                        <button class="time-plan-btn dynamic-button" data-weeks="8">8 Weeks</button>
                        <button class="time-plan-btn dynamic-button" data-weeks="10">10 Weeks</button>
                    </div>
                </div>
                <div id="level-selection-section" class="hidden animate-on-load glass-card p-6 md:p-8 mt-8">
                    <h3 class="text-2xl font-bold text-center text-white mb-6" style="font-family: 'Space Grotesk', sans-serif;">Choose Your Skill Level</h3>
                    <div class="flex flex-wrap justify-center gap-4">
                        <button class="level-btn dynamic-button" data-level="Beginner">Beginner</button>
                        <button class="level-btn dynamic-button" data-level="Intermediate">Intermediate</button>
                        <button class="level-btn dynamic-button" data-level="Expert">Expert</button>
                    </div>
                </div>
            `;
            
            resultsArea.innerHTML = suggestionsHtml;
        }

        /**
         * Handles the request to generate a learning roadmap.
         * @param {string} skillName The name of the skill.
         * @param {string} weeks The duration of the roadmap in weeks.
         * @param {string} level The difficulty level of the roadmap.
         */
        async function handleGetRoadmap(skillName, weeks, level) {
            clearError();
            
            // Hide input section and all selection sections
            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('suggestions-container')?.classList.add('hidden');
            document.getElementById('time-plan-section')?.classList.add('hidden');
            document.getElementById('level-selection-section')?.classList.add('hidden');
            
            const learningStyle = document.querySelector('input[name="learning-style"]:checked').value;
            showLoader(`Building your ${weeks}-week ${level} roadmap for a ${learningStyle} learner...`);
            
            const prompt = `Create a ${weeks}-week ${level} learning roadmap for "${skillName}". Tailor for ${learningStyle} learning style. Return JSON with: 'skill', 'roadmap' array (week number, theme, 3 goals, 2 resources with title & searchQuery), 'freePlatforms' (2 objects), 'paidPlatforms' (2 objects), 'books' (2 objects) - each with name, description, searchQuery.`;
            
            const platformSchema = { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" }, searchQuery: { type: "STRING" } }, required: ["name", "description", "searchQuery"] } };
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            skill: { type: "STRING" },
                            roadmap: { type: "ARRAY", items: { type: "OBJECT", properties: { week: { type: "NUMBER" }, theme: { type: "STRING" }, goals: { type: "ARRAY", items: { type: "STRING" } }, resources: { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, searchQuery: { type: "STRING" } }, required: ["title", "searchQuery"] } } }, required: ["week", "theme", "goals", "resources"] } },
                            freePlatforms: platformSchema,
                            paidPlatforms: platformSchema,
                            books: platformSchema
                        },
                        required: ["skill", "roadmap", "freePlatforms", "paidPlatforms", "books"]
                    }
                }
            };

            try {
                // Start roadmap generation and prefetching in parallel
                const roadmapPromise = fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey1); // Roadmap uses apiKey1
                
                // Start prefetching after a short delay to ensure variables are ready
                setTimeout(() => {
                    prefetchAllFeatures(skillName).catch(err => {
                        console.warn('Prefetch failed:', err);
                    });
                }, 100);
                
                const result = await roadmapPromise;
                
                // Validate API response
                if (!result || !result.candidates || !result.candidates[0] || !result.candidates[0].content) {
                    throw new Error('Invalid API response structure');
                }
                
                const textContent = result.candidates[0].content.parts[0].text;
                roadmapData = JSON.parse(textContent);
                
                // Validate roadmap data
                if (!roadmapData.skill || !roadmapData.roadmap || roadmapData.roadmap.length === 0) {
                    throw new Error('Invalid roadmap data structure');
                }
                
                displayRoadmap(roadmapData);
            } catch (err) {
                console.error('Roadmap generation error:', err);
                showError('Failed to generate roadmap: ' + err.message);
                resultsArea.innerHTML = `
                    <div class="glass-card p-8 text-center">
                        <p class="text-red-400 mb-4">âš ï¸ Failed to generate roadmap. Please try again.</p>
                        <button id="retry-roadmap-btn" class="dynamic-button" onclick="handleGetRoadmap('${skillName}', '${weeks}', '${level}')">
                            ðŸ”„ Retry
                        </button>
                        <button id="start-over-btn" class="dynamic-button secondary-button ml-4">
                            â† Start Over
                        </button>
                    </div>
                `;
            }
        }

        /**
         * Renders the complete roadmap on the page.
         * @param {object} data The roadmap data object.
         */
        function displayRoadmap(data) {
            let roadmapHtml = `
                <div id="roadmap-container" class="glass-card p-6 md:p-8 animate-on-load">
                    <div class="relative flex justify-center items-center mb-4">
                        <button id="back-to-input-btn" class="absolute left-0 dynamic-button secondary-button !px-3 !py-2 inline-flex items-center">
                            <ion-icon name="arrow-back-outline" class="text-xl"></ion-icon>
                        </button>
                        <div class="flex justify-center items-center gap-4">
                            <h2 class="text-2xl md:text-3xl font-bold text-white text-center" style="font-family: 'Space Grotesk', sans-serif;">
                                Roadmap to: <span style="background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${data.skill}</span>
                            </h2>
                            <button id="narrate-roadmap-btn" class="dynamic-button !p-3 !rounded-full" title="Listen to Summary">ðŸŽ§</button>
                        </div>
                    </div>
                    <div class="text-center">
                        <div id="toughness-display" class="mt-4 text-center"></div>
                        <p class="text-center text-gray-400 my-4">Your ${data.roadmap.length}-week journey starts now.</p>
                    </div>
                    <!-- NEW: Academic Suggestor Section -->
                    <div id="academic-suggestor-section" class="hidden glass-card p-6 my-8">
                        <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">Next Academic Step</h2>
                        <div id="academic-suggestor-content"></div>
                    </div>
                    <div class="glass-card p-6 my-8">
                        <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">Top AI Features</h2>
                        <div class="flex flex-wrap justify-center items-center gap-4">
                               <button id="setup-guide-btn" class="dynamic-button ai-feature-btn">ðŸš€ Setup Guide</button>
                               <button id="deep-dive-btn" data-skill-name="${data.skill}" class="dynamic-button ai-feature-btn">âœ¨ Deep Dive</button>
                               <button id="suggest-project-btn" data-skill-name="${data.skill}" class="dynamic-button ai-feature-btn">ðŸ’¡ Personalized Projects</button>
                               <button id="study-plan-btn" class="dynamic-button ai-feature-btn">ðŸ—“ï¸ Plan a Study Session</button>
                               <button id="career-recommender-btn" class="dynamic-button ai-feature-btn">ðŸ§­ Recommend a Career</button>
                               <button id="news-button" class="dynamic-button ai-feature-btn">ðŸ“° Latest Education News</button>
                        </div>
                    </div>

                    <!-- NEW: Dynamic AI Features -->
                    <div class="glass-card p-6 my-8">
                        <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">Dynamic AI Features</h2>
                        <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                            <select id="dynamic-learning-style" class="bg-gray-800/50 border border-gray-600 rounded-lg px-4 py-2 text-white">
                                <option value="Visual">Adapt to Visual</option>
                                <option value="Practical">Adapt to Practical</option>
                                <option value="Theoretical">Adapt to Theoretical</option>
                                <option value="Balanced">Adapt to Balanced</option>
                            </select>
                            <button id="learning-style-adapter-btn" class="dynamic-button">Adapt My Path</button>
                        </div>
                    </div>
                    
                    <div class="timeline-container space-y-8">
            `;
            data.roadmap.forEach((week, index) => {
                roadmapHtml += `
                    <div class="timeline-item animate-on-load" style="animation-delay: ${index * 200}ms;">
                        <div class="ml-4">
                            <div class="flex justify-between items-center flex-wrap gap-2">
                                <h3 class="text-xl font-bold text-white"><span class="text-gray-500">Week ${week.week}:</span> ${week.theme}</h3>
                            </div>
                            <!-- AI Features Box -->
                            <div class="glass-card p-4 my-4 rounded-xl">
                                <h4 class="font-semibold text-center text-white mb-3" style="font-family: 'Orbitron', sans-serif;">âœ¨ AI Learning Toolkit âœ¨</h4>
                                <div class="flex flex-wrap gap-2 justify-center">
                                    <button class="eli5-btn dynamic-button !px-3 !py-1 text-sm" data-week-theme="${week.theme}" data-skill-name="${data.skill}">ðŸ‘¶ ELI5</button>
                                    <button class="scenario-btn dynamic-button !px-3 !py-1 text-sm" data-week-theme="${week.theme}" data-skill-name="${data.skill}">ðŸ’¼ Real-World Scenario</button>
                                    <button class="im-stuck-btn dynamic-button !px-3 !py-1 text-sm" data-week-theme="${week.theme}" data-skill-name="${data.skill}">ðŸ†˜ I'm Stuck!</button>
                                    <button class="quiz-me-btn dynamic-button !px-3 !py-1 text-sm" data-week-theme="${week.theme}" data-skill-name="${data.skill}">ðŸ§  Quiz Me</button>
                                    <button class="flashcard-btn dynamic-button !px-3 !py-1 text-sm" data-week-theme="${week.theme}" data-skill-name="${data.skill}">ðŸƒ Flashcards</button>
                                    <button class="visualize-btn dynamic-button !px-3 !py-1 text-sm" data-week-theme="${week.theme}" data-skill-name="${data.skill}">ðŸŽ¨ Visualize</button>
                                    <button class="concept-connector-btn dynamic-button !px-3 !py-1 text-sm" data-week-theme="${week.theme}" data-skill-name="${data.skill}">ðŸ”— Link Concepts</button>
                                    <button class="debate-btn dynamic-button !px-3 !py-1 text-sm" data-week-theme="${week.theme}" data-skill-name="${data.skill}">âš”ï¸ Debate Topic</button>
                                </div>
                            </div>
                            <div class="mt-4 p-4 bg-gray-900/50 border border-gray-700 rounded-lg">
                                <h4 class="font-semibold text-gray-300">Goals:</h4>
                                <ul class="list-disc list-inside mt-2 space-y-1 text-gray-400">
                                    ${week.goals.map(goal => `<li>${goal}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="mt-4">
                                <button class="toggle-resources-btn flex justify-between items-center w-full text-left font-semibold text-gray-300 mb-2 p-2 rounded-lg hover:bg-gray-800/50 transition-colors">
                                    <span>Suggested Resources:</span>
                                    <ion-icon name="chevron-down-outline" class="transition-transform duration-300 text-xl"></ion-icon>
                                </button>
                                <ul class="resource-list hidden space-y-2">
                                    <li>
                                        <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(`${data.skill} ${week.theme} tutorial`)}" target="_blank" rel="noopener noreferrer" class="flex items-center p-3 rounded-lg bg-red-900/50 hover:bg-red-800/70 border border-red-700 hover:border-red-500 transition-all duration-200">
                                            <ion-icon name="logo-youtube" class="text-2xl mr-3 text-red-500"></ion-icon>
                                            <span class="font-medium text-gray-300">YouTube Video Tutorials for ${week.theme}</span>
                                        </a>
                                    </li>
                                    ${week.resources.map(resource => `
                                    <li>
                                        <a href="https://www.google.com/search?q=${encodeURIComponent(resource.searchQuery)}" target="_blank" rel="noopener noreferrer" class="flex items-center p-3 rounded-lg bg-gray-800/50 hover:bg-gray-700/70 border border-gray-700 hover:border-blue-400 transition-all duration-200">
                                            <ion-icon name="search-circle-outline" class="text-2xl mr-3 text-blue-400"></ion-icon>
                                            <span class="font-medium text-gray-300">${resource.title}</span>
                                        </a>
                                    </li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>`;
            });
            roadmapHtml += `</div>`;
            
            // New Job Trend Graph Section
            roadmapHtml += `
                    <div id="job-trend-section" class="mt-12 border-t border-gray-700 pt-8 text-center animate-on-load">
                        <h3 class="text-2xl font-bold text-white mb-4" style="font-family: 'Space Grotesk', sans-serif;">Future Job Outlook</h3>
                        <div class="h-64 md:h-80"><canvas id="jobTrendChart"></canvas></div>
                        <div class="mt-6 flex gap-4 justify-center">
                            <button id="timeline-tracker-btn" class="dynamic-button ai-feature-btn">ðŸ“… Academic Timeline</button>
                            <button id="milestones-btn" class="dynamic-button ai-feature-btn">ðŸŽ¯ Learning Milestones</button>
                        </div>
                    </div>
            `;
            
            // New Offline Centers Section
            roadmapHtml += `
                <div id="offline-explorer-section" class="mt-12 border-t border-gray-700 pt-8 text-center animate-on-load" style="animation-delay: ${data.roadmap.length * 200 + 300}ms;">
                    <h3 class="text-2xl font-bold text-white mb-4" style="font-family: 'Space Grotesk', sans-serif;">Find Local Learning Opportunities</h3>
                    <button id="offline-centers-btn" data-skill-name="${data.skill}" class="dynamic-button">ðŸ“ Explore Offline Centers</button>
                    <div id="offline-centers-results" class="mt-6 text-left"></div>
                </div>
            `;

            roadmapHtml += `<div class="mt-12 border-t border-gray-700 pt-8">
                                <h3 class="text-2xl font-bold text-center text-white mb-6" style="font-family: 'Space Grotesk', sans-serif;">Online Platforms</h3>`;
            if(data.freePlatforms && data.freePlatforms.length > 0) {
                roadmapHtml += `<div class="mb-8 animate-on-load" style="animation-delay: ${data.roadmap.length * 200}ms;">
                                        <h3 class="text-2xl font-bold text-center text-white mb-4" style="font-family: 'Space Grotesk', sans-serif;">Free Learning Platforms</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(data.skill)}" target="_blank" rel="noopener noreferrer" class="block p-4 bg-red-900/30 rounded-lg border border-red-700 hover:bg-red-800/50 hover:border-red-500 transition">
                                                <h4 class="font-bold text-red-300">YouTube</h4>
                                                <p class="text-sm text-red-400 mt-1">A vast library of video tutorials and explanations for free.</p>
                                            </a>
                                            ${data.freePlatforms.map(p => `
                                                <a href="https://www.google.com/search?q=${encodeURIComponent(p.searchQuery)}" target="_blank" rel="noopener noreferrer" class="block p-4 bg-green-900/30 rounded-lg border border-green-700 hover:bg-green-800/50 hover:border-green-500 transition">
                                                    <h4 class="font-bold text-green-300">${p.name}</h4>
                                                    <p class="text-sm text-green-400 mt-1">${p.description}</p>
                                                </a>`).join('')}
                                        </div></div>`;
            }

            if(data.paidPlatforms && data.paidPlatforms.length > 0) {
                roadmapHtml += `<div class="animate-on-load" style="animation-delay: ${data.roadmap.length * 200 + 100}ms;">
                                        <h3 class="text-2xl font-bold text-center text-white mb-4" style="font-family: 'Space Grotesk', sans-serif;">Premium Platforms</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${data.paidPlatforms.map(p => `
                                                <a href="https://www.google.com/search?q=${encodeURIComponent(p.searchQuery)}" target="_blank" rel="noopener noreferrer" class="block p-4 bg-purple-900/30 rounded-lg border border-purple-700 hover:bg-purple-800/50 hover:border-purple-500 transition">
                                                    <h4 class="font-bold text-purple-300">${p.name}</h4>
                                                    <p class="text-sm text-purple-400 mt-1">${p.description}</p>
                                                </a>`).join('')}
                                        </div></div>`;
            }
            if(data.books && data.books.length > 0) {
                roadmapHtml += `<div class="mt-8 animate-on-load" style="animation-delay: ${data.roadmap.length * 200 + 250}ms;">
                                        <h3 class="text-2xl font-bold text-center text-white mb-4" style="font-family: 'Space Grotesk', sans-serif;">E-books & Best Books</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${data.books.map(b => `
                                                <a href="https://www.google.com/search?q=${encodeURIComponent(b.searchQuery)}" target="_blank" rel="noopener noreferrer" class="block p-4 bg-amber-900/30 rounded-lg border border-amber-700 hover:bg-amber-800/50 hover:border-amber-500 transition">
                                                    <h4 class="font-bold text-amber-300">${b.name}</h4>
                                                    <p class="text-sm text-amber-400 mt-1">${b.description}</p>
                                                </a>`).join('')}
                                        </div></div>`;
            }
            roadmapHtml += `</div>`;
            
            // Career Path Explorer Section
            roadmapHtml += `
                <div id="career-explorer-section" class="mt-12 border-t border-gray-700 pt-8 text-center animate-on-load" style="animation-delay: ${data.roadmap.length * 200 + 350}ms;">
                    <h3 class="text-2xl font-bold text-white mb-4" style="font-family: 'Space Grotesk', sans-serif;">Connect Your Skill to a Career</h3>
                    <button id="career-explorer-btn" data-skill-name="${data.skill}" class="dynamic-button">âœ¨ Explore Career Paths</button>
                    <div id="career-results" class="mt-6 text-left"></div>
                </div>
            `;

            roadmapHtml += `<div class="mt-12 text-center"><button id="start-over-btn" class="dynamic-button">Start a New Path</button></div>`;
            roadmapHtml += `</div>`;
            resultsArea.innerHTML = roadmapHtml;

            // --- Trigger background processing in parallel ---
            // Run both background processes simultaneously using apiKey2
            fetchAndDisplayToughness(data.skill, apiKey2);
            renderJobTrendGraph(data.skill, apiKey2);

            // Show the AI Coach FAB
            aiCoachFab.dataset.skillName = data.skill;
            aiCoachFab.classList.add('visible');
            
            const academicSuggestorSection = document.getElementById('academic-suggestor-section');
            const academicLevelInput = document.querySelector('input[name="pursuing-class"]:checked');
            if (academicLevelInput && academicSuggestorSection) {
                const academicLevel = academicLevelInput.value;
                console.log('ðŸ“š Academic level detected:', academicLevel);
                if (academicLevel === 'Class 10' || academicLevel === 'Class 12') {
                     academicSuggestorSection.classList.remove('hidden');
                     displayAcademicSuggestorButton(academicLevel);
                }
            } else {
                console.warn('âš ï¸ Academic level not selected or section not found');
            }
            
            // Prefetching already started in parallel during roadmap generation
        }
        
        /**
         * Prefetches all 16 AI features in the background for instant display
         * Uses apiKey2 for all AI features (parallel to roadmap generation with apiKey1)
         * Features: Setup Guide, Deep Dive, Career Explorer, Projects, Study Plan, 
         * Flashcards, Quiz, Mock Interview, Career Recommendation, Offline Centers,
         * ELI5, Real World Scenario, Debate Topic, Toughness Calculator, 
         * Timeline Tracker (milestones), Academic Timeline (entrance exams/scholarships)
         */
        async function prefetchAllFeatures(skillName) {
            if (isPrefetching) return;
            isPrefetching = true;
            console.log('ðŸš€ Starting prefetch of all AI features with apiKey2...');
            
            // Use a default theme since roadmap might not be ready yet
            const weekTheme = 'Introduction to ' + skillName;
            
            // Kick off all feature prefetches in parallel (use apiKey2)
            const allFeatures = [
                // Academic Timeline kept at first index for logging priority but runs concurrently
                prefetchAcademicTimeline(skillName, apiKey2),
                prefetchSetupGuide(skillName, apiKey2),
                prefetchDeepDive(skillName, apiKey2),
                prefetchCareerExplorer(skillName, apiKey2),
                prefetchProjectSuggestions(skillName, apiKey2),
                prefetchStudyPlan(weekTheme, 90, apiKey2),
                prefetchFlashcards(weekTheme, apiKey2),
                prefetchQuiz(weekTheme, apiKey2),
                prefetchMockInterview(skillName, apiKey2),
                prefetchCareerRecommendation(skillName, apiKey2),
                prefetchOfflineCenters(skillName, apiKey2),
                prefetchELI5(weekTheme, skillName, apiKey2),
                prefetchRealWorldScenario(weekTheme, skillName, apiKey2),
                prefetchDebateTopic(weekTheme, skillName, apiKey2),
                prefetchToughnessCalculator(skillName, apiKey2),
                prefetchTimelineTracker(skillName, apiKey2)
            ];
            
            // Execute all prefetch promises concurrently; log overall status
            try {
                const results = await Promise.allSettled(allFeatures);
                const successful = results.filter(r => r.status === 'fulfilled').length;
                const failed = results.filter(r => r.status === 'rejected').length;
                console.log(`âœ… Prefetch complete: ${successful} successful, ${failed} failed`);
                
                if (failed > 0) {
                    console.warn('Failed features:', results.filter(r => r.status === 'rejected').map(r => r.reason));
                }
            } catch (err) {
                console.warn('âš ï¸ Prefetch error:', err);
            } finally {
                isPrefetching = false;
            }
        }
        
        // Prefetch individual features
        async function prefetchSetupGuide(skillName, apiKey) {
            if (prefetchCache.setupGuide) return Promise.resolve();
            try {
                const prompt = `Provide a step-by-step setup guide for a complete beginner starting to learn '${skillName}'. Include: (1) Software/Tools to install, (2) Development environment setup, (3) First "Hello World" equivalent, (4) Essential resources. Return 3-4 setup steps.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                setupSteps: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            title: { type: "STRING" },
                                            description: { type: "STRING" },
                                            searchQuery: { type: "STRING" }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.setupGuide = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Setup Guide');
                return Promise.resolve();
            } catch (err) {
                console.warn('âœ— Failed to prefetch Setup Guide:', err.message);
                return Promise.reject(err);
            }
        }
        
        async function prefetchDeepDive(skillName, apiKey) {
            if (prefetchCache.deepDive) return;
            try {
                const prompt = `Provide a detailed overview of '${skillName}' for a beginner: (1) What is it? (2) Why is it useful? (3) Why should someone learn it?`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                what_is_it: { type: "STRING" },
                                why_useful: { type: "STRING" },
                                why_learn: { type: "STRING" }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.deepDive = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Deep Dive');
            } catch (err) {
                console.warn('âœ— Failed to prefetch Deep Dive:', err.message);
            }
        }
        
        async function prefetchCareerExplorer(skillName, apiKey) {
            if (prefetchCache.careerExplorer) return;
            try {
                const prompt = `List 4 career paths that heavily use '${skillName}'. For each, provide title and a brief description.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                careers: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            title: { type: "STRING" },
                                            description: { type: "STRING" }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.careerExplorer = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Career Explorer');
            } catch (err) {
                console.warn('âœ— Failed to prefetch Career Explorer:', err.message);
            }
        }
        
        async function prefetchProjectSuggestions(skillName, apiKey) {
            if (prefetchCache.projectSuggestions) return;
            try {
                const prompt = `Suggest 3 beginner-friendly project ideas for someone learning '${skillName}'. Each project should have a title and description.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                projects: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            title: { type: "STRING" },
                                            description: { type: "STRING" }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.projectSuggestions = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Project Suggestions');
            } catch (err) {
                console.warn('âœ— Failed to prefetch Project Suggestions:', err.message);
            }
        }
        
        async function prefetchStudyPlan(weekTheme, minutes, apiKey) {
            if (prefetchCache.studyPlan) return;
            try {
                const prompt = `Create a focused ${minutes}-minute study session plan for learning about '${weekTheme}'. Break down the session into timed activities.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                plan: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            activity: { type: "STRING" },
                                            duration_minutes: { type: "NUMBER" }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.studyPlan = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Study Plan');
            } catch (err) {
                console.warn('âœ— Failed to prefetch Study Plan:', err.message);
            }
        }
        
        async function prefetchFlashcards(weekTheme, apiKey) {
            if (prefetchCache.flashcards) return;
            try {
                const prompt = `Create 5 flashcards for learning '${weekTheme}'. Each flashcard should have a term and definition.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                flashcards: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            term: { type: "STRING" },
                                            definition: { type: "STRING" }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.flashcards = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Flashcards');
            } catch (err) {
                console.warn('âœ— Failed to prefetch Flashcards:', err.message);
            }
        }
        
        async function prefetchQuiz(weekTheme, apiKey) {
            if (prefetchCache.quiz) return;
            try {
                const prompt = `Generate 3 multiple-choice quiz questions about '${weekTheme}' for beginners.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                quiz: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            question: { type: "STRING" },
                                            options: { type: "ARRAY", items: { type: "STRING" } },
                                            correctAnswer: { type: "STRING" }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.quiz = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Quiz');
            } catch (err) {
                console.warn('âœ— Failed to prefetch Quiz:', err.message);
            }
        }
        
        async function prefetchMockInterview(skillName, apiKey) {
            if (prefetchCache.mockInterview) return;
            try {
                const prompt = `Generate 3 technical interview questions for an entry-level position requiring '${skillName}' skills.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                interviewQuestions: { type: "ARRAY", items: { type: "STRING" } }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.mockInterview = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Mock Interview');
            } catch (err) {
                console.warn('âœ— Failed to prefetch Mock Interview:', err.message);
            }
        }
        
        async function prefetchCareerRecommendation(skillName, apiKey) {
            if (prefetchCache.careerRecommendation) return;
            try {
                const prompt = `Based on the skill '${skillName}', recommend one career path with reasoning and next steps.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                career_title: { type: "STRING" },
                                reason: { type: "STRING" },
                                next_steps: { type: "ARRAY", items: { type: "STRING" } }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.careerRecommendation = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Career Recommendation');
            } catch (err) {
                console.warn('âœ— Failed to prefetch Career Recommendation:', err.message);
            }
        }
        
        async function prefetchOfflineCenters(skillName, apiKey) {
            if (prefetchCache.offlineCenters) return Promise.resolve();
            try {
                const prompt = `Suggest 3 offline learning centers or institutions where one can learn '${skillName}' with descriptions.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                centers: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            name: { type: "STRING" },
                                            description: { type: "STRING" },
                                            searchQuery: { type: "STRING" }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.offlineCenters = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Offline Centers');
                return Promise.resolve();
            } catch (err) {
                console.warn('âœ— Failed to prefetch Offline Centers:', err.message);
                return Promise.reject(err);
            }
        }
        
        async function prefetchELI5(weekTheme, skillName, apiKey) {
            if (prefetchCache.eli5) return Promise.resolve();
            try {
                const prompt = `Explain '${weekTheme}' in '${skillName}' as if I'm 5 years old. Use simple language, analogies, and examples.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                explanation: { type: "STRING" }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.eli5 = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: ELI5');
                return Promise.resolve();
            } catch (err) {
                console.warn('âœ— Failed to prefetch ELI5:', err.message);
                return Promise.reject(err);
            }
        }
        
        async function prefetchRealWorldScenario(weekTheme, skillName, apiKey) {
            if (prefetchCache.realWorldScenario) return Promise.resolve();
            try {
                const prompt = `Describe a real-world scenario where '${weekTheme}' in '${skillName}' is applied professionally.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                scenario: { type: "STRING" }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.realWorldScenario = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Real World Scenario');
                return Promise.resolve();
            } catch (err) {
                console.warn('âœ— Failed to prefetch Real World Scenario:', err.message);
                return Promise.reject(err);
            }
        }
        
        async function prefetchDebateTopic(weekTheme, skillName, apiKey) {
            if (prefetchCache.debateTopic) return Promise.resolve();
            try {
                const prompt = `Create a thought-provoking debate topic related to '${weekTheme}' in '${skillName}' with arguments for both sides.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                topic: { type: "STRING" },
                                forArguments: { type: "ARRAY", items: { type: "STRING" } },
                                againstArguments: { type: "ARRAY", items: { type: "STRING" } }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.debateTopic = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Debate Topic');
                return Promise.resolve();
            } catch (err) {
                console.warn('âœ— Failed to prefetch Debate Topic:', err.message);
                return Promise.reject(err);
            }
        }
        
        async function prefetchToughnessCalculator(skillName, apiKey) {
            if (prefetchCache.toughnessCalculator) return Promise.resolve();
            try {
                const prompt = `On a scale of 1 to 100, how challenging is it for a complete beginner to master '${skillName}'? Return JSON with 'toughness' (number) and 'justification' (string, max 60 chars).`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                toughness: { type: "NUMBER" },
                                justification: { type: "STRING" }
                            },
                            required: ["toughness", "justification"]
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.toughnessCalculator = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Toughness Calculator');
                return Promise.resolve();
            } catch (err) {
                console.warn('âœ— Failed to prefetch Toughness Calculator:', err.message);
                return Promise.reject(err);
            }
        }
        
        async function prefetchTimelineTracker(skillName, apiKey) {
            if (prefetchCache.timelineTracker) return Promise.resolve();
            try {
                const prompt = `Create a milestone-based timeline for mastering '${skillName}' with 5 key checkpoints and estimated timeframes.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                milestones: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            title: { type: "STRING" },
                                            description: { type: "STRING" },
                                            timeframe: { type: "STRING" }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.timelineTracker = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Timeline Tracker');
                return Promise.resolve();
            } catch (err) {
                console.warn('âœ— Failed to prefetch Timeline Tracker:', err.message);
                return Promise.reject(err);
            }
        }
        
        async function prefetchAcademicTimeline(skillName, apiKey) {
            if (prefetchCache.academicTimeline) return Promise.resolve();
            try {
                const pursuingClass = document.querySelector('input[name="pursuing-class"]:checked')?.value || 'Graduation';
                const stream = document.querySelector('input[name="stream"]:checked')?.value || 'General';
                
                const prompt = `Generate timeline of academic events in India for '${pursuingClass}' (${stream} stream) learning '${skillName}'. Include entrance exams, admissions, scholarships, counseling (next 6-8 months from Sept 2025). Max 6 events.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                timelineEvents: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            eventName: { type: "STRING" },
                                            eventType: { type: "STRING" },
                                            estimatedDate: { type: "STRING" },
                                            description: { type: "STRING" }
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                prefetchCache.academicTimeline = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log('âœ“ Prefetched: Academic Timeline');
                return Promise.resolve();
            } catch (err) {
                console.warn('âœ— Failed to prefetch Academic Timeline:', err.message);
                return Promise.reject(err);
            }
        }
        
        /**
         * Renders the academic suggestor button.
         * @param {string} academicLevel The current academic level of the user.
         */
        function displayAcademicSuggestorButton(academicLevel) {
            const container = document.getElementById('academic-suggestor-content');
            let buttonText = '';
            if (academicLevel === 'Class 10') {
                buttonText = 'Suggest Next Academic Plan';
            } else if (academicLevel === 'Class 12') {
                buttonText = 'Suggest Next Degree Program';
            } else {
                return;
            }

            container.innerHTML = `
                <div class="text-center">
                    <button id="next-academic-suggestor-btn" class="dynamic-button secondary-button">${buttonText}</button>
                    <div id="academic-suggestor-results" class="mt-4 text-left"></div>
                </div>
            `;
        }

        /**
         * Generate fallback academic suggestions when API fails
         */
        function generateFallbackAcademicSuggestions(academicLevel, currentStream, userSkills, userInterests) {
            console.log('ðŸ”„ Generating fallback academic suggestions for:', academicLevel, currentStream);
            
            let suggestions = [];
            
            if (academicLevel === 'Class 10') {
                suggestions = [
                    {
                        name: "Science Stream (PCM/PCB)",
                        description: "Traditional path for engineering, medical, and research careers. Choose PCM for engineering/tech or PCB for medical/life sciences.",
                        searchQuery: "Class 11 science stream subjects career options India"
                    },
                    {
                        name: "Commerce Stream",
                        description: "Ideal for business, finance, and management careers. Opens doors to CA, CS, banking, and entrepreneurship.",
                        searchQuery: "Class 11 commerce stream career options India"
                    },
                    {
                        name: "Diploma Courses",
                        description: "Practical, skill-based programs in engineering, design, or technology. Shorter duration with direct job opportunities.",
                        searchQuery: "diploma courses after class 10 India career prospects"
                    }
                ];
            } else if (academicLevel === 'Class 12') {
                if (currentStream === 'Science') {
                    suggestions = [
                        {
                            name: "B.Tech/B.E. Engineering",
                            description: "Traditional engineering degrees in various specializations like Computer Science, Mechanical, Electrical, etc.",
                            searchQuery: "BTech engineering colleges India admission 2024"
                        },
                        {
                            name: "B.Sc. in Applied Sciences",
                            description: "Bachelor's in Physics, Chemistry, Mathematics, or emerging fields like Data Science and Biotechnology.",
                            searchQuery: "BSc applied sciences career opportunities India"
                        },
                        {
                            name: "Medical/Allied Health",
                            description: "MBBS, BDS, or allied health programs like Physiotherapy, Nursing, Medical Technology.",
                            searchQuery: "medical courses after 12th science India NEET"
                        },
                        {
                            name: "Design & Creative Fields",
                            description: "Bachelor's in Design (UI/UX, Product, Fashion), Animation, or Architecture combining creativity with technology.",
                            searchQuery: "design courses after 12th science India career"
                        }
                    ];
                } else if (currentStream === 'Commerce') {
                    suggestions = [
                        {
                            name: "B.Com/BBA Business",
                            description: "Foundation in business, accounting, and management. Gateway to MBA, CA, CS, and corporate careers.",
                            searchQuery: "BCom BBA courses India career opportunities"
                        },
                        {
                            name: "Economics/Finance",
                            description: "B.A./B.Sc. Economics or specialized finance programs. Great for banking, consulting, and policy roles.",
                            searchQuery: "economics finance courses after 12th commerce India"
                        },
                        {
                            name: "Law (Integrated)",
                            description: "5-year integrated law programs (BA LLB, BBA LLB) combining legal studies with other disciplines.",
                            searchQuery: "integrated law courses after 12th India CLAT"
                        },
                        {
                            name: "Digital Marketing/E-commerce",
                            description: "Modern business programs focusing on digital economy, online marketing, and e-commerce management.",
                            searchQuery: "digital marketing courses after 12th commerce India"
                        }
                    ];
                } else {
                    // Arts/Humanities or other streams
                    suggestions = [
                        {
                            name: "Liberal Arts/Humanities",
                            description: "B.A. in subjects like Psychology, Sociology, Political Science, or interdisciplinary liberal arts programs.",
                            searchQuery: "liberal arts humanities courses India career options"
                        },
                        {
                            name: "Mass Communication/Journalism",
                            description: "Bachelor's in Journalism, Mass Communication, or Media Studies for careers in media and communications.",
                            searchQuery: "mass communication journalism courses India career"
                        },
                        {
                            name: "Social Work/Development",
                            description: "Bachelor's in Social Work or Development Studies for careers in NGOs, government, and social sector.",
                            searchQuery: "social work development studies courses India career"
                        },
                        {
                            name: "Creative Arts",
                            description: "Bachelor's in Fine Arts, Music, Theatre, or Creative Writing for artistic and cultural careers.",
                            searchQuery: "creative arts courses after 12th India career opportunities"
                        }
                    ];
                }
            }
            
            return { suggestions: suggestions, isFallback: true };
        }

        /**
         * Fetches and displays academic suggestions for the user's current level.
         * @param {string} academicLevel The current academic level.
         * @param {string} currentStream The user's current stream/field.
         */
        async function handleNextAcademicSuggestion(academicLevel, currentStream) {
            console.log('ðŸŽ¯ Starting Next Academic Suggestion for:', academicLevel, currentStream);
            
            const container = document.getElementById('academic-suggestor-results');
            const button = document.getElementById('next-academic-suggestor-btn');
            
            if (!container) {
                console.error('âŒ academic-suggestor-results container not found');
                return;
            }
            
            if (!button) {
                console.error('âŒ next-academic-suggestor-btn button not found');
                return;
            }
            
            button.disabled = true;
            showLoader('Generating your next academic plan...', container);

            let prompt = '';
            let promptTitle = '';
            const userSkills = skillsInput ? skillsInput.value.trim() : '';
            const userInterests = interestsInput ? interestsInput.value.trim() : '';
            
            if (!userSkills || !userInterests) {
                container.innerHTML = `<p class="text-yellow-400 text-sm">âš ï¸ Please enter your skills and interests first to get personalized suggestions.</p>`;
                button.disabled = false;
                return;
            }

            if (academicLevel === 'Class 10') {
                promptTitle = 'Suggested Paths After Class 10';
                prompt = `You are a helpful academic advisor for Indian students. A student in Class 10 with interests in "${userInterests}" and skills in "${userSkills}" wants to explore their academic and vocational options. Provide a mix of traditional and non-traditional paths. Suggest 3 options. Each option should have a 'name' and a 'description' (1-2 simple sentences for someone with an average knowledge level). For practical options like Diploma and ITI, provide 2-3 common branches relevant to their interests. Return a JSON object with a 'suggestions' array. Each object should have 'name' and 'description' and a 'searchQuery' to find more information.`;
            } else if (academicLevel === 'Class 12') {
                promptTitle = `Suggested Degree Programs After Class 12 (${currentStream})`;
                prompt = `You are a career advisor for Indian students. A student in Class 12, currently in the "${currentStream}" stream, with interests in "${userInterests}" and skills in "${userSkills}" is looking for degree options. Suggest 4 diverse degree programs in simple words. Do not only suggest B.Tech/B.E. Include options like B.B.A, B.Com, B.Sc, and other relevant fields. For each suggestion, provide a 'name', a 2-3 sentence 'description' of what the degree is about, and a 'searchQuery' for further research.`;
            }

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            suggestions: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        description: { type: "STRING" },
                                        searchQuery: { type: "STRING" }
                                    },
                                    required: ["name", "description", "searchQuery"]
                                }
                            }
                        },
                        required: ["suggestions"]
                    }
                }
            };
            

            // Try API call with retry logic
            let data = null;
            const maxRetries = 2;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`ðŸ“¡ API attempt ${attempt}/${maxRetries} for academic suggestions...`);
                    const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey());
                    
                    if (!result || !result.candidates || !result.candidates[0]) {
                        throw new Error('Invalid API response structure');
                    }
                    
                    data = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    if (!data.suggestions || data.suggestions.length === 0) {
                        throw new Error('No suggestions in API response');
                    }
                    
                    console.log('âœ… Academic suggestions received:', data.suggestions.length, 'options');
                    break; // Success, exit retry loop
                    
                } catch (err) {
                    console.warn(`âš ï¸ Academic API attempt ${attempt} failed:`, err.message);
                    
                    if (attempt === maxRetries) {
                        // All retries failed, use fallback
                        console.log('âš ï¸ All API attempts failed. Using fallback suggestions.');
                        data = generateFallbackAcademicSuggestions(academicLevel, currentStream, userSkills, userInterests);
                    } else {
                        // Wait before retry
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                }
            }
            
            try {
                if (!data || !data.suggestions) {
                    throw new Error('Failed to generate any suggestions');
                }
                
                let suggestionsHtml = `
                    <h3 class="text-xl font-bold text-white mb-4">${promptTitle}</h3>
                `;
                
                // Add notice if using fallback data
                if (data.isFallback) {
                    suggestionsHtml += `
                        <div class="mb-4 p-3 bg-yellow-900/30 border border-yellow-600/50 rounded-lg">
                            <p class="text-yellow-400 text-sm">â„¹ï¸ Showing general suggestions (personalized recommendations temporarily unavailable)</p>
                        </div>
                    `;
                }
                
                suggestionsHtml += `<ul class="space-y-4">`;
                data.suggestions.forEach(sugg => {
                    let link = '';
                    if (sugg.searchQuery) {
                        link = `<a href="https://www.google.com/search?q=${encodeURIComponent(sugg.searchQuery)}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline text-sm">Explore courses</a>`;
                    }
                    suggestionsHtml += `
                        <li class="p-4 bg-gray-900/50 rounded-lg border border-gray-700">
                            <h4 class="font-bold text-teal-300">${sugg.name}</h4>
                            <p class="text-gray-400 mt-1">${sugg.description}</p>
                            ${link}
                        </li>
                    `;
                });
                suggestionsHtml += `</ul>`;
                container.innerHTML = suggestionsHtml;
                
            } catch (renderErr) {
                console.error('âŒ Failed to render academic suggestions:', renderErr);
                container.innerHTML = `
                    <div class="text-center p-4">
                        <p class="text-red-400 text-sm mb-2">âš ï¸ Could not display academic suggestions</p>
                        <p class="text-gray-500 text-xs">${renderErr.message}</p>
                        <button onclick="handleNextAcademicSuggestion('${academicLevel}', '${currentStream}')" class="mt-3 dynamic-button secondary-button text-xs">Retry</button>
                    </div>
                `;
            } finally {
                button.disabled = false;
            }
        }


        /**
         * Fetches and displays a difficulty rating for the skill.
         * @param {string} skillName The skill to analyze.
         * @param {string} apiKey The API key to use.
         */
        function renderToughnessFallback(skillName, errorMessage) {
            const container = document.getElementById('toughness-display');
            if (!container) return;
            container.innerHTML = `
                <div class="p-4 bg-gray-900/50 rounded-lg border border-gray-700 text-center">
                    <p class="text-red-400 text-sm mb-2">âš ï¸ Could not retrieve toughness data.</p>
                    ${errorMessage ? `<p class="text-gray-500 text-xs">${errorMessage}</p>` : ''}
                </div>
            `;
        }

        /**
         * Generate fallback toughness data when API fails
         */
        function generateFallbackToughnessData(skillName) {
            console.log('ðŸ”„ Generating fallback toughness data for:', skillName);
            
            // Generate realistic toughness based on skill name patterns
            const easySkills = ['email', 'basic computer', 'microsoft word', 'social media', 'typing'];
            const moderateSkills = ['excel', 'powerpoint', 'photography', 'writing', 'communication'];
            const hardSkills = ['programming', 'coding', 'machine learning', 'ai', 'data science', 'blockchain'];
            const veryHardSkills = ['quantum computing', 'advanced mathematics', 'neural networks', 'cryptography'];
            
            const skillLower = skillName.toLowerCase();
            let toughness = 50; // Default moderate difficulty
            let justification = `Learning ${skillName} requires moderate effort and practice.`;
            
            if (easySkills.some(skill => skillLower.includes(skill))) {
                toughness = Math.floor(20 + Math.random() * 25); // 20-45%
                justification = `${skillName} is beginner-friendly and can be learned with basic practice.`;
            } else if (veryHardSkills.some(skill => skillLower.includes(skill))) {
                toughness = Math.floor(75 + Math.random() * 20); // 75-95%
                justification = `${skillName} is highly complex and requires extensive study and experience.`;
            } else if (hardSkills.some(skill => skillLower.includes(skill))) {
                toughness = Math.floor(60 + Math.random() * 20); // 60-80%
                justification = `${skillName} involves technical concepts and requires dedicated learning time.`;
            } else if (moderateSkills.some(skill => skillLower.includes(skill))) {
                toughness = Math.floor(35 + Math.random() * 25); // 35-60%
                justification = `${skillName} has a manageable learning curve with regular practice.`;
            } else {
                // Default case based on skill length and complexity indicators
                if (skillLower.includes('advanced') || skillLower.includes('expert')) {
                    toughness = Math.floor(65 + Math.random() * 20); // 65-85%
                    justification = `Advanced ${skillName} requires significant time investment and expertise.`;
                } else if (skillLower.includes('basic') || skillLower.includes('intro')) {
                    toughness = Math.floor(25 + Math.random() * 25); // 25-50%
                    justification = `Basic ${skillName} concepts are accessible to most learners.`;
                }
            }
            
            return {
                toughness: toughness,
                justification: justification,
                isFallback: true
            };
        }

        async function fetchAndDisplayToughness(skillName, apiKey) {
            console.log('ðŸ”¢ Starting Toughness Calculator for:', skillName);
            const container = document.getElementById('toughness-display');
            if (!container) {
                console.error('âŒ toughness-display container not found');
                return;
            }
            
            // Check prefetch cache first
            if (prefetchCache.toughnessCalculator) {
                const data = prefetchCache.toughnessCalculator;
                console.log('âš¡ Loading Toughness from cache:', data);
                const justification = data.justification || data.explanation || 'No explanation available';
                const toughness = data.toughness || (data.rating ? data.rating * 10 : 50);
                const shortExplanation = justification.length > 80 ? justification.substring(0, 80) + '...' : justification;
                container.innerHTML = `
                    <div class="flex items-center justify-center">
                        <div class="font-bold text-white text-lg" style="font-family: 'Space Grotesk', sans-serif;">Toughness:</div>
                        <div class="ml-2 text-2xl font-bold" style="color: var(--accent-color);">${toughness}%</div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">${shortExplanation}</p>
                `;
                return;
            }
            
            container.innerHTML = `<div class="flex justify-center items-center text-sm text-gray-400"><div class="w-4 h-4 border-2 border-dashed rounded-full animate-spin mr-2" style="border-top-color: var(--accent-color); border-left-color: var(--accent-color);"></div>Analyzing difficulty...</div>`;

            const prompt = `On a scale of 1 to 100, how tough is it for an absolute beginner to learn the skill "${skillName}"? Provide a 'toughness' percentage (as a number) and a brief 'justification' (1 sentence).`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            toughness: { type: "NUMBER" },
                            justification: { type: "STRING" }
                        },
                        required: ["toughness", "justification"]
                    }
                }
            };

            // Try API call with retry logic
            let data = null;
            const maxRetries = 2;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`ðŸ“¡ Toughness API attempt ${attempt}/${maxRetries}...`);
                    const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                    
                    if (!result || !result.candidates || !result.candidates[0]) {
                        throw new Error('Invalid API response structure');
                    }
                    
                    data = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    if (typeof data.toughness !== 'number' || !data.justification) {
                        throw new Error('Missing toughness or justification fields');
                    }
                    
                    console.log('âœ… Toughness data received from API:', data);
                    break; // Success, exit retry loop
                    
                } catch (err) {
                    console.warn(`âš ï¸ Toughness attempt ${attempt} failed:`, err.message);
                    
                    if (attempt === maxRetries) {
                        console.error('âŒ All toughness API attempts failed.');
                        data = null;
                    } else {
                        // Wait before retry
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                }
            }
            
            try {
                if (!data) {
                    throw new Error('Failed to get toughness data');
                }
                
                const shortJustification = data.justification.length > 80 ? data.justification.substring(0, 80) + '...' : data.justification;
                let displayHtml = `
                    <div class="flex items-center justify-center">
                        <div class="font-bold text-white text-lg" style="font-family: 'Space Grotesk', sans-serif;">Toughness:</div>
                        <div class="ml-2 text-2xl font-bold" style="color: var(--accent-color);">${data.toughness}%</div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">${shortJustification}</p>
                `;
                
                
                container.innerHTML = displayHtml;
                
            } catch (renderErr) {
                console.error('âŒ Failed to render toughness data:', renderErr);
                renderToughnessFallback(skillName, renderErr.message);
            }
        }

        /**
         * Fetches trend data and renders the job trend graph.
         * @param {string} skillName The skill to generate a graph for.
         * @param {string} apiKey The API key to use.
         */
        /**
         * Helper function to generate fallback trend data when API fails
         */
        function generateFallbackTrendData(skillName) {
            console.log('ðŸ”„ Generating fallback trend data for:', skillName);
            // Generate realistic fallback data based on skill name patterns
            const techSkills = ['python', 'javascript', 'react', 'ai', 'machine learning', 'data'];
            const isTech = techSkills.some(tech => skillName.toLowerCase().includes(tech));
            
            return {
                trend: isTech ? "high growth" : "moderate growth",
                base_jobs: Math.floor(30000 + Math.random() * 50000)
            };
        }

        function renderJobTrendFallback(skillName, fallbackData, errorMessage) {
            const chartSection = document.getElementById('job-trend-section');
            if (!chartSection) return;
            const data = fallbackData || generateFallbackTrendData(skillName || '');
            const titleSkill = skillName && skillName.length ? skillName : 'Selected skill';
            const trendLabel = data.trend ? data.trend.charAt(0).toUpperCase() + data.trend.slice(1) : 'Unknown';
            chartSection.innerHTML = `
                <div class="p-4 bg-gray-900/50 rounded-lg border border-gray-700">
                    <h4 class="text-white font-bold text-lg mb-2">Estimated Job Outlook for ${titleSkill}</h4>
                    <p class="text-gray-300 text-sm mb-2">Projected demand trend: <span class="text-blue-400 font-semibold">${trendLabel}</span></p>
                    <p class="text-gray-400 text-xs">Approximate current openings baseline: <span class="text-gray-200 font-semibold">${data.base_jobs.toLocaleString()}</span></p>
                    <p class="text-gray-500 text-xs mt-3">Live job trend service is temporarily unavailable, so this estimate was generated locally.</p>
                    ${errorMessage ? `<p class="text-red-400 text-xs mt-3">${errorMessage}</p>` : ''}
                </div>
            `;
        }

        async function renderJobTrendGraph(skillName, apiKey) {
            console.log('ðŸ“Š Starting Job Trend Graph generation for:', skillName);
            
            if (jobTrendChart) {
                jobTrendChart.destroy();
                jobTrendChart = null;
            }
            
            // Check if canvas exists before proceeding
            const canvasElement = document.getElementById('jobTrendChart');
            if (!canvasElement) {
                console.error('âŒ Job Trend Chart canvas not found in DOM. Skipping graph generation.');
                return;
            }
            
            // Show loader overlay while AI prepares the graph
            const jobTrendSection = document.getElementById('job-trend-section');
            if (jobTrendSection) {
                let loader = document.getElementById('job-trend-loader');
                if (!loader) {
                    loader = document.createElement('div');
                    loader.id = 'job-trend-loader';
                    loader.className = 'flex justify-center items-center h-64 text-gray-400';
                    loader.innerHTML = `<div class="w-6 h-6 border-2 border-dashed rounded-full animate-spin mr-2" style="border-top-color: var(--accent-color); border-left-color: var(--accent-color);"></div><span>AI is generating the job trend graph...</span>`;
                    jobTrendSection.appendChild(loader);
                }
                canvasElement.style.display = 'none';
            }

            let trendData = null;
            let isUsingFallback = false;
            
            // Try API call with retry logic
            const maxRetries = 2;
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`ðŸ“¡ API attempt ${attempt}/${maxRetries} for job trend...`);
                    
                    const prompt = `Analyze job market trend for "${skillName}": high growth, moderate growth, stable, or declining? Provide base job count (number like 45000). JSON: {"trend": string, "base_jobs": number}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    trend: { type: "STRING" },
                                    base_jobs: { type: "NUMBER" }
                                },
                                required: ["trend", "base_jobs"]
                            }
                        }
                    };
                    
                    const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, apiKey);
                    
                    if (!result || !result.candidates || !result.candidates[0]) {
                        throw new Error('Invalid API response');
                    }
                    
                    trendData = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    if (!trendData.trend || !trendData.base_jobs) {
                        throw new Error('Missing required fields');
                    }
                    
                    console.log('âœ… Job Trend Data received from API:', trendData);
                    break; // Success, exit retry loop
                    
                } catch (err) {
                    console.warn(`âš ï¸ Attempt ${attempt} failed:`, err.message);
                    
                    if (attempt === maxRetries) {
                        // All retries failed, use fallback
                        console.log('âš ï¸ All API attempts failed. Using fallback data.');
                        trendData = generateFallbackTrendData(skillName);
                        isUsingFallback = true;
                    } else {
                        // Wait before retry (exponential backoff)
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                }
            }
            
            // If still no data (shouldn't happen with fallback), abort
            if (!trendData) {
                throw new Error('Failed to generate trend data');
            }
            
            try {
                console.log('ðŸ“ˆ Rendering graph with data:', trendData);
                
                let multiplier;
                switch (trendData.trend) {
                    case "high growth": multiplier = 1.20; break;
                    case "moderate growth": multiplier = 1.10; break;
                    case "stable": multiplier = 1.01; break;
                    case "declining": multiplier = 0.95; break;
                    default: multiplier = 1.05;
                }

                const labels = [];
                const dataPoints = [];
                const currentYear = new Date().getFullYear();

                for (let i = -2; i <= 4; i++) {
                    labels.push(String(currentYear + (i * 2)));
                }
                
                let currentJobs = trendData.base_jobs;
                dataPoints.push(currentJobs);

                for (let i = 0; i < 5; i++) {
                    currentJobs = currentJobs * (multiplier - 0.05 + Math.random() * 0.1); // Add some randomness
                    dataPoints.push(Math.round(currentJobs));
                }
                
                // Double-check canvas still exists
                const canvas = document.getElementById('jobTrendChart');
                if (!canvas) {
                    console.error('âŒ Canvas element disappeared during processing');
                    return;
                }

                if (typeof Chart === 'undefined') {
                    throw new Error('Chart library unavailable');
                }
                const ctx = canvas.getContext('2d');
                jobTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Job Openings for ${skillName}`,
                            data: dataPoints,
                            borderColor: 'rgba(0, 198, 255, 0.8)',
                            backgroundColor: 'rgba(0, 198, 255, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(0, 198, 255, 1)',
                            pointBorderColor: '#fff',
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#a1a1aa' }
                            },
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#a1a1aa' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#e4e4e7' } },
                            tooltip: {
                                titleColor: '#fff',
                                bodyColor: '#ccc',
                                backgroundColor: '#0c0a09',
                                borderColor: 'rgba(255, 255, 255, 0.2)',
                                borderWidth: 1
                            }
                        }
                    }
                });

                console.log('âœ… Job Trend Graph rendered successfully');
                // Remove loader and reveal canvas
                const loaderDone = document.getElementById('job-trend-loader');
                if (loaderDone) loaderDone.remove();
                canvasElement.style.display = 'block';
                
            } catch (err) {
                console.error('âŒ Could not render job trend graph:', err.message);
                console.error('Full error:', err);
                renderJobTrendFallback(skillName, trendData, err.message);
                // Remove loader on error as well
                const loaderErr = document.getElementById('job-trend-loader');
                if (loaderErr) loaderErr.remove();
                const canvasErr = document.getElementById('jobTrendChart');
                if (canvasErr) canvasErr.style.display = 'block';
            }
        }


        /**
         * Fetches and displays a deep-dive explanation in the feature modal.
         * @param {string} skillName The skill to deep dive into.
         */
        async function handleDeepDive(skillName) {
            featureModalOverlay.classList.add('visible');
            
            // Check cache first for instant loading
            if (prefetchCache.deepDive) {
                console.log('âš¡ Loading Deep Dive from cache (instant)');
                const data = prefetchCache.deepDive;
                featureModalContent.innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-4" style="font-family: 'Orbitron', sans-serif;">Deep Dive: ${skillName}</h2>
                    <div class="text-gray-300 space-y-4">
                        <div><strong class="text-white">What is it?</strong><br>${data.what_is_it}</div>
                        <div><strong class="text-white">Why is it useful?</strong><br>${data.why_useful}</div>
                        <div><strong class="text-white">Why learn it?</strong><br>${data.why_learn}</div>
                    </div>
                    <div id="analogy-area" class="mt-4 text-center">
                        <button id="analogy-btn" data-skill-name="${skillName}" class="dynamic-button secondary-button">ðŸ¤” Explain with an Analogy</button>
                    </div>
                    <div class="text-center mt-6">
                        <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                    </div>
                `;
                return;
            }
            
            showLoader(`Diving deep into ${skillName}...`, featureModalContent);

            const prompt = `Please provide a beginner-friendly "deep dive" explanation for the skill: "${skillName}". Structure the response in three paragraphs:
            1.  **What is it?** A clear, concise definition of the skill.
            2.  **Why is it useful?** Explain its real-world applications and the problems it solves.
            3.  **Why learn it?** Describe the value and benefits of learning this skill for personal or professional growth.
            Keep the tone encouraging and accessible.`;
            
            const payload = { 
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            what_is_it: { type: "STRING" },
                            why_useful: { type: "STRING" },
                            why_learn: { type: "STRING" }
                        },
                        required: ["what_is_it", "why_useful", "why_learn"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                featureModalContent.innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-4" style="font-family: 'Orbitron', sans-serif;">Deep Dive: ${skillName}</h2>
                    <div class="text-gray-300 space-y-4">
                        <div><strong class="text-white">What is it?</strong><br>${data.what_is_it}</div>
                        <div><strong class="text-white">Why is it useful?</strong><br>${data.why_useful}</div>
                        <div><strong class="text-white">Why learn it?</strong><br>${data.why_learn}</div>
                    </div>
                    <div id="analogy-area" class="mt-4 text-center">
                        <button id="analogy-btn" data-skill-name="${skillName}" class="dynamic-button secondary-button">ðŸ¤” Explain with an Analogy</button>
                    </div>
                    <div class="text-center mt-6">
                        <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                    </div>
                `;
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not fetch explanation. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }
        
        /**
         * Fetches and displays potential career paths in the main content area.
         * @param {string} skillName The skill to explore careers for.
         */
        async function handleCareerExplorer(skillName) {
            const careerBtn = document.getElementById('career-explorer-btn');
            const careerResultsContainer = document.getElementById('career-results');
            careerBtn.disabled = true;
            
            // Check cache first for instant loading
            if (prefetchCache.careerExplorer) {
                console.log('âš¡ Loading Career Explorer from cache (instant)');
                const data = prefetchCache.careerExplorer;
                let careersHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">';
                data.careers.forEach(career => {
                    careersHtml += `
                        <div class="career-card glass-card p-4 border-l-4 border-amber-500 cursor-pointer transition-transform hover:scale-105" data-career-title="${career.title}">
                            <h4 class="font-bold text-amber-300 pointer-events-none">${career.title}</h4>
                            <p class="text-sm text-gray-400 mt-1 pointer-events-none">${career.description}</p>
                        </div>
                    `;
                });
                careersHtml += '</div>';
                careerResultsContainer.innerHTML = careersHtml;
                careerBtn.style.display = 'none'; // Hide button after use
                return;
            }
            
            showLoader(`Exploring careers for ${skillName}...`, careerResultsContainer);

            const prompt = `For someone learning the skill "${skillName}", suggest 3-4 potential career paths. For each career, provide a 'title' and a short 'description' (1-2 sentences) of what the role entails and how it uses the skill.`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            careers: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        title: { type: "STRING" },
                                        description: { type: "STRING" }
                                    },
                                    required: ["title", "description"]
                                }
                            }
                        },
                        required: ["careers"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                prefetchCache.careerExplorer = data; // Cache for future use
                let careersHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">';
                data.careers.forEach(career => {
                    careersHtml += `
                        <div class="career-card glass-card p-4 border-l-4 border-amber-500 cursor-pointer transition-transform hover:scale-105" data-career-title="${career.title}">
                            <h4 class="font-bold text-amber-300 pointer-events-none">${career.title}</h4>
                            <p class="text-sm text-gray-400 mt-1 pointer-events-none">${career.description}</p>
                        </div>
                    `;
                });
                careersHtml += '</div>';
                careerResultsContainer.innerHTML = careersHtml;
            } catch (err) {
                careerResultsContainer.innerHTML = `<p class="text-red-400 text-center">Could not fetch career paths. ${err.message}</p>`;
            } finally {
                careerBtn.style.display = 'none'; // Hide button after use
            }
        }
        
        /**
         * Fetches and displays a future scope analysis in the feature modal.
         * @param {string} careerTitle The title of the career to analyze.
         */
        async function handleCareerDeepDive(careerTitle) {
            showLoader(`Creating a deep dive for ${careerTitle}...`, featureModalContent);
            featureModalOverlay.classList.add('visible');

            const prompt = `Please provide a "Career Deep Dive" for a '${careerTitle}' role. The response should be a JSON object with the following properties:
            1. "key_responsibilities": An array of 3-4 strings listing the primary responsibilities for the role.
            2. "salary_insights": An object with three keys: "fresher" (e.g., "$50k - $70k USD"), "mid_level" (for 3+ years exp, e.g., "$80k - $120k USD"), and "senior_level" (for 5+ years exp, e.g., "$130k - $180k+ USD").
            3. "top_companies": An array of 3-4 strings listing top companies hiring for this role globally.`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            key_responsibilities: { type: "ARRAY", items: { type: "STRING" } },
                            salary_insights: {
                                type: "OBJECT",
                                properties: {
                                    fresher: { type: "STRING" },
                                    mid_level: { type: "STRING" },
                                    senior_level: { type: "STRING" }
                                },
                                required: ["fresher", "mid_level", "senior_level"]
                            },
                            top_companies: { type: "ARRAY", items: { type: "STRING" } }
                        },
                        required: ["key_responsibilities", "salary_insights", "top_companies"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                featureModalContent.innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-4" style="font-family: 'Orbitron', sans-serif;">Career Deep Dive: ${careerTitle}</h2>
                    <div class="text-gray-300 space-y-6">
                        <div>
                            <h3 class="font-bold text-lg text-white mb-2">Key Responsibilities</h3>
                            <ul class="list-disc list-inside space-y-1 text-gray-400">
                                ${data.key_responsibilities.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-white mb-2">Salary Insights (USD)</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                                <div class="bg-gray-800/50 p-3 rounded-lg">
                                    <p class="text-sm text-gray-400">Fresher</p>
                                    <p class="font-bold text-white">${data.salary_insights.fresher}</p>
                                </div>
                                <div class="bg-gray-800/50 p-3 rounded-lg">
                                    <p class="text-sm text-gray-400">3+ Years Exp</p>
                                    <p class="font-bold text-white">${data.salary_insights.mid_level}</p>
                                </div>
                                <div class="bg-gray-800/50 p-3 rounded-lg">
                                    <p class="text-sm text-gray-400">5+ Years Exp</p>
                                    <p class="font-bold text-white">${data.salary_insights.senior_level}</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-white mb-2">Top Companies Hiring</h3>
                            <div class="flex flex-wrap gap-2">
                                ${data.top_companies.map(company => `<span class="bg-blue-900/50 text-blue-300 text-xs font-medium px-2.5 py-1 rounded-full border border-blue-700">${company}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                    <div id="interview-prep-area" class="mt-8 text-center">
                            <button id="mock-interview-btn" data-skill-name="${selectedSkill}" data-career-title="${careerTitle}" class="dynamic-button secondary-button">âœ¨ Start Mock Interview</button>
                    </div>
                    <div class="text-center mt-6">
                        <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                    </div>
                `;
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not fetch career details. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }
        
        /**
         * Fetches and displays project suggestions in the feature modal.
         * @param {string} skillName The skill to suggest projects for.
         */
        async function handleProjectSuggestions(skillName) {
            showLoader(`Suggesting projects for ${skillName}...`, featureModalContent);
            featureModalOverlay.classList.add('visible');

            const userInterests = interestsInput.value.trim();
            const prompt = `A user is learning '${skillName}' and is interested in '${userInterests}'. Generate 3 unique, beginner-friendly project ideas that combine the skill with their interests. For each, provide a "title" and a one-sentence "description".`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            projects: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        title: { type: "STRING" },
                                        description: { type: "STRING" }
                                    },
                                    required: ["title", "description"]
                                }
                            }
                        },
                        required: ["projects"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                prefetchCache.projectSuggestions = data; // Cache for future use
                let projectsHtml = `
                    <h2 class="text-2xl font-bold text-white mb-4" style="font-family: 'Orbitron', sans-serif;">Personalized Project Ideas âœ¨</h2>
                    <div class="space-y-4">
                `;
                data.projects.forEach(project => {
                    projectsHtml += `
                        <div class="project-card glass-card p-4 border-l-4 border-green-500 cursor-pointer transition-transform hover:scale-105" data-project-title="${project.title}" data-skill-name="${skillName}">
                            <h4 class="font-bold text-green-300 pointer-events-none">${project.title}</h4>
                            <p class="text-sm text-gray-400 mt-1 pointer-events-none">${project.description}</p>
                        </div>
                    `;
                });
                projectsHtml += `</div>
                    <div class="text-center mt-6">
                        <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                    </div>
                `;
                featureModalContent.innerHTML = projectsHtml;
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not fetch project ideas. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }
        
        /**
         * Fetches and displays project details in the feature modal.
         * @param {string} projectTitle The title of the project to brief.
         * @param {string} skillName The associated skill.
         */
        async function handleProjectDetails(projectTitle, skillName) {
            showLoader(`Building a brief for ${projectTitle}...`, featureModalContent);
            
            const prompt = `Provide a detailed project brief for a beginner creating a "${projectTitle}" to practice the skill "${skillName}". The response should be a JSON object with the following keys: "project_overview" (a 2-3 sentence summary), "core_features" (an array of 3-4 key features to implement), "tech_stack_suggestions" (an array of suggested technologies), and "example_links" (an array of 2-3 objects, each with a "title" and a "searchQuery" to find similar real-world examples).`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            project_overview: { type: "STRING" },
                            core_features: { type: "ARRAY", items: { type: "STRING" } },
                            tech_stack_suggestions: { type: "ARRAY", items: { type: "STRING" } },
                            example_links: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        title: { type: "STRING" },
                                        searchQuery: { type: "STRING" }
                                    },
                                    required: ["title", "searchQuery"]
                                }
                            }
                        },
                        required: ["project_overview", "core_features", "tech_stack_suggestions", "example_links"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                let detailsHtml = `
                    <h2 class="text-2xl font-bold text-white mb-4" style="font-family: 'Orbitron', sans-serif;">Project Brief: ${projectTitle}</h2>
                    <div class="text-gray-300 space-y-4">
                        <div>
                            <h3 class="font-bold text-lg text-white mb-2">Project Overview</h3>
                            <p>${data.project_overview}</p>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-white mb-2">Core Features</h3>
                            <ul class="list-disc list-inside space-y-1">
                                ${data.core_features.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-white mb-2">Tech Stack Suggestions</h3>
                            <div class="flex flex-wrap gap-2">
                                ${data.tech_stack_suggestions.map(tech => `<span class="bg-gray-700 text-gray-300 text-xs font-medium px-2.5 py-1 rounded-full">${tech}</span>`).join('')}
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-white mb-2">Real-World Examples</h3>
                            <ul class="space-y-2">
                                ${data.example_links.map(link => `
                                <li>
                                    <a href="https://www.google.com/search?q=${encodeURIComponent(link.searchQuery)}" target="_blank" rel="noopener noreferrer" class="flex items-center p-3 rounded-lg bg-gray-800/50 hover:bg-gray-700/70 border border-gray-700 hover:border-blue-400 transition-all duration-200">
                                        <ion-icon name="search-circle-outline" class="text-2xl mr-3 text-blue-400"></ion-icon>
                                        <span class="font-medium text-gray-300">${link.title}</span>
                                    </a>
                                </li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    <div id="code-critique-area" class="mt-6 text-center">
                        <button id="code-critique-btn" data-skill-name="${skillName}" data-project-title="${projectTitle}" class="dynamic-button secondary-button">âœ¨ Critique My Code</button>
                    </div>
                    <div class="text-center mt-6">
                        <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                    </div>
                `;
                featureModalContent.innerHTML = detailsHtml;
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not fetch project details. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }

        /**
         * Opens and initializes the AI Coach chat modal.
         * @param {string} skillName The skill the user is learning.
         */
        function openAiCoachChat(skillName) {
            const chatHeader = document.getElementById('chat-header');
            const chatMessages = document.getElementById('chat-messages');
            
            chatHeader.textContent = `AI Coach: ${skillName}`;
            chatHistory = []; // Reset history
            
            const welcomeMessage = `Hello! I'm your AI learning coach for ${skillName}. How can I help you on your learning journey today? Ask me for explanations, examples, or advice!`;
            chatMessages.innerHTML = `
                <div class="chat-message model">
                    <div class="chat-bubble model">${welcomeMessage}</div>
                </div>
            `;
            
            aiCoachChatModalOverlay.classList.add('visible');
        }

        /**
         * Handles sending a message to the AI Coach.
         * @param {Event} event The form submission event.
         */
        async function handleChatMessage(event) {
            event.preventDefault();
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const chatMessages = document.getElementById('chat-messages');
            const userInput = chatInput.value.trim();

            if (!userInput) return;

            // Display user message immediately
            chatMessages.innerHTML += `
                <div class="chat-message user">
                    <div class="chat-bubble user">${userInput}</div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
            chatInput.value = '';
            chatSendBtn.disabled = true;

            // Add a thinking indicator for the model
            chatMessages.innerHTML += `
                <div class="chat-message model" id="thinking-indicator">
                    <div class="chat-bubble model">
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0s;"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Prepare API call
            const prompt = `You are 'Horizon', a friendly and encouraging AI learning coach. The user is currently learning about '${selectedSkill}'. Maintain this persona. Do not use markdown.

            The user's new message is:
            ${userInput}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const responseText = result.candidates[0].content.parts[0].text;
                
                // Update history
                chatHistory.push({ role: "user", parts: [{ text: userInput }] });
                chatHistory.push({ role: "model", parts: [{ text: responseText }] });
                
                // Display model response
                const thinkingIndicator = document.getElementById('thinking-indicator');
                if(thinkingIndicator) thinkingIndicator.remove();

                chatMessages.innerHTML += `
                    <div class="chat-message model">
                        <div class="chat-bubble model">${responseText.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            } catch (err) {
                const thinkingIndicator = document.getElementById('thinking-indicator');
                if(thinkingIndicator) thinkingIndicator.remove();
                chatMessages.innerHTML += `
                    <div class="chat-message model">
                        <div class="chat-bubble model text-red-400">Sorry, I had trouble connecting. Please try again.</div>
                    </div>
                `;
            } finally {
                chatSendBtn.disabled = false;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        /**
         * Fetches and displays the multi-step setup guide.
         */
        async function handleGetSetupSteps() {
            if (!roadmapData) return;
            const skillName = roadmapData.skill;

            featureModalOverlay.classList.add('visible');
            
            // Check cache first for instant loading
            if (prefetchCache.setupGuide) {
                console.log('âš¡ Loading Setup Guide from cache (instant)');
                currentSetupSteps = prefetchCache.setupGuide.setupSteps;
                currentStepIndex = 0;
                displaySetupStep();
                return;
            }

            showLoader(`Generating setup guide for ${skillName}...`, featureModalContent);

            const prompt = `Create a series of 3-4 simple, sequential setup steps for a beginner learning '${skillName}'. The steps should cover environment setup, installing necessary software, and running a 'hello world' equivalent. Provide a JSON object with a 'setupSteps' array. Each object in the array should have a 'title' (e.g., 'Step 1: Install Python'), a 'description' (a few sentences explaining how and why), and a 'searchQuery' (a concise Google search term to find a tutorial or download page for that step).`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            setupSteps: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        title: { type: "STRING" },
                                        description: { type: "STRING" },
                                        searchQuery: { type: "STRING" }
                                    },
                                    required: ["title", "description", "searchQuery"]
                                }
                            }
                        },
                        required: ["setupSteps"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                prefetchCache.setupGuide = data; // Cache for future use
                currentSetupSteps = data.setupSteps;
                currentStepIndex = 0;
                displaySetupStep();
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not generate a setup guide. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }

        /**
         * Renders the current setup step in the modal.
         */
        function displaySetupStep() {
            const step = currentSetupSteps[currentStepIndex];
            const isFirstStep = currentStepIndex === 0;
            const isLastStep = currentStepIndex === currentSetupSteps.length - 1;

            let html = `
                <h2 class="text-2xl font-bold text-white mb-2 text-center" style="font-family: 'Orbitron', sans-serif;">Setup Guide: ${roadmapData.skill}</h2>
                <p class="text-center text-gray-400 mb-6">Step ${currentStepIndex + 1} of ${currentSetupSteps.length}</p>
                <div class="mb-6">
                    <h3 class="font-bold text-xl text-white mb-2">${step.title}</h3>
                    <p class="text-gray-300 mb-4">${step.description.replace(/\n/g, '<br>')}</p>
                    <a href="https://www.google.com/search?q=${encodeURIComponent(step.searchQuery)}" target="_blank" rel="noopener noreferrer" class="flex items-center p-3 rounded-lg bg-gray-800/50 hover:bg-gray-700/70 border border-gray-700 hover:border-blue-400 transition-all duration-200">
                        <ion-icon name="search-circle-outline" class="text-2xl mr-3 text-blue-400"></ion-icon>
                        <span class="font-medium text-gray-300">Search for: ${step.searchQuery}</span>
                    </a>
                </div>
                <div class="flex justify-between items-center mt-8">
                    <button id="prev-step-btn" class="dynamic-button secondary-button" ${isFirstStep ? 'disabled' : ''}>Previous</button>
                    <button id="next-step-btn" class="dynamic-button">${isLastStep ? 'Finish' : 'Next'}</button>
                </div>
            `;
            featureModalContent.innerHTML = html;
        }


        /**
         * Fetches and displays an AI-generated quiz in the feature modal.
         * @param {string} skillName The skill being learned.
         * @param {string} weekTheme The theme of the week's quiz.
         */
        async function handleGetQuiz(skillName, weekTheme) {
            featureModalOverlay.classList.add('visible');
            
            // Check cache first for instant loading
            if (prefetchCache.quiz) {
                console.log('âš¡ Loading Quiz from cache (instant)');
                displayQuiz(prefetchCache.quiz.quiz);
                return;
            }
            
            showLoader(`Creating a quiz for ${weekTheme}...`, featureModalContent);

            const prompt = `You are an AI tutor. Create a simple multiple-choice quiz with 3 questions to test a beginner's understanding of the topic: '${weekTheme}' for the skill '${skillName}'. Provide the response as a JSON object with a 'quiz' array. Each item in the array should have a 'question', an array of 'options', and the 'correctAnswer' (the text of the correct option).`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            quiz: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        question: { type: "STRING" },
                                        options: { type: "ARRAY", items: { type: "STRING" } },
                                        correctAnswer: { type: "STRING" }
                                    },
                                    required: ["question", "options", "correctAnswer"]
                                }
                            }
                        },
                        required: ["quiz"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                prefetchCache.quiz = data; // Cache for future use
                displayQuiz(data.quiz);
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not generate a quiz. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }

        /**
         * Renders the interactive quiz in the modal.
         * @param {Array<object>} quizData The array of quiz questions.
         */
        function displayQuiz(quizData) {
            let quizHtml = `
                <h2 class="text-2xl font-bold text-white mb-6 text-center" style="font-family: 'Orbitron', sans-serif;">Knowledge Check ðŸ§ </h2>
                <div id="quiz-container">
            `;
            quizData.forEach((q, index) => {
                quizHtml += `
                    <div class="mb-6 quiz-question" data-correct-answer="${q.correctAnswer}">
                        <p class="font-semibold mb-3">${index + 1}. ${q.question}</p>
                        <div class="quiz-options">
                            ${q.options.map(opt => `<button class="quiz-option w-full text-left">${opt}</button>`).join('')}
                        </div>
                    </div>
                `;
            });
            quizHtml += `</div>
                <div class="text-center mt-6">
                    <button id="submit-quiz-btn" class="dynamic-button">Submit Answers</button>
                    <div id="quiz-results" class="mt-4 font-bold text-xl"></div>
                </div>
            `;
            featureModalContent.innerHTML = quizHtml;
        }

        /**
         * Fetches and displays an analogy in the feature modal.
         * @param {string} skillName The skill to get an analogy for.
         */
        async function handleGetAnalogy(skillName) {
            const analogyArea = document.getElementById('analogy-area');
            analogyArea.innerHTML = `<div class="flex justify-center items-center text-sm text-gray-400"><div class="w-4 h-4 border-2 border-dashed rounded-full animate-spin mr-2"></div>Generating analogy...</div>`;
            
            const prompt = `Explain the concept of '${skillName}' using a simple, relatable analogy for a complete beginner.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const analogy = result.candidates[0].content.parts[0].text;
                analogyArea.innerHTML = `
                    <div class="p-4 bg-gray-900/50 border border-gray-700 rounded-lg text-left">
                        <h4 class="font-semibold text-lg text-white mb-2">ðŸ¤” Analogy Time</h4>
                        <p class="text-gray-300">${analogy.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            } catch (err) {
                analogyArea.innerHTML = `<p class="text-xs text-red-400">Could not generate an analogy. ${err.message}</p>`;
            }
        }

        /**
         * Handles the "I'm Stuck" feature.
         * @param {string} skillName The skill being learned.
         * @param {string} weekTheme The theme of the week's topic.
         */
        function handleLearningBlocker(skillName, weekTheme) {
            let html = `
                <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">Learning Blocker Assistant</h2>
                <p class="text-center text-gray-400 mb-4">Describe what you're stuck on regarding "${weekTheme}".</p>
                <textarea id="blocker-input" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition text-white placeholder-gray-500" rows="4" placeholder="e.g., I don't understand how 'for loops' are different from 'while loops'..."></textarea>
                <div id="blocker-response-area" class="mt-4"></div>
                <div class="text-center mt-6">
                    <button id="submit-blocker-btn" data-skill-name="${skillName}" data-week-theme="${weekTheme}" class="dynamic-button">Get Help</button>
                </div>
            `;
            featureModalContent.innerHTML = html;
            featureModalOverlay.classList.add('visible');
        }

        /**
         * Fetches and displays help for a learning blocker.
         * @param {string} skillName The skill being learned.
         * @param {string} weekTheme The theme of the week's topic.
         * @param {string} problemDescription The user's description of the problem.
         */
        async function fetchBlockerHelp(skillName, weekTheme, problemDescription) {
            const responseArea = document.getElementById('blocker-response-area');
            showLoader('Thinking of a new way to explain this...', responseArea);

            const prompt = `You are a helpful AI tutor. A beginner learning '${skillName}' is stuck on a concept from their lesson on '${weekTheme}'. They describe their problem as: "${problemDescription}". Please provide a simple, clear explanation from a different perspective or use an analogy to help them understand. Do not just repeat the definition.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const helpText = result.candidates[0].content.parts[0].text;
                responseArea.innerHTML = `
                    <div class="p-4 bg-gray-900/50 border border-gray-700 rounded-lg text-left">
                        <p class="text-gray-300">${helpText.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            } catch (err) {
                responseArea.innerHTML = `<p class="text-xs text-red-400">Sorry, I couldn't generate an explanation right now. ${err.message}</p>`;
            }
        }

        /**
         * Handles the Code Critiquer feature.
         * @param {string} skillName The skill being learned.
         * @param {string} projectTitle The project context.
         */
        function handleCodeCritique(skillName, projectTitle) {
            let html = `
                <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">AI Code Critiquer</h2>
                <p class="text-center text-gray-400 mb-4">Paste your code for the "${projectTitle}" project below. I'll give you some friendly feedback!</p>
                <textarea id="code-input" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition text-white placeholder-gray-500 font-mono" rows="8" placeholder="Paste your code here..."></textarea>
                <div id="critique-response-area" class="mt-4"></div>
                <div class="text-center mt-6">
                    <button id="submit-critique-btn" data-skill-name="${skillName}" data-project-title="${projectTitle}" class="dynamic-button">Get Feedback</button>
                </div>
            `;
            featureModalContent.innerHTML = html;
            featureModalOverlay.classList.add('visible');
        }

        /**
         * Fetches and displays a code critique.
         * @param {string} skillName The skill context.
         * @param {string} projectTitle The project context.
         * @param {string} userCode The code to be critiqued.
         */
        async function fetchCodeCritique(skillName, projectTitle, userCode) {
            const responseArea = document.getElementById('critique-response-area');
            showLoader('Analyzing your code...', responseArea);

            const prompt = `You are a friendly and constructive AI code reviewer. A beginner learning '${skillName}' has submitted their code for a project called '${projectTitle}'. Their code is:\n\n\`\`\`\n${userCode}\n\`\`\`\n\nPlease provide helpful feedback. Focus on one or two key areas for improvement. Explain *why* a change is better, not just what to change. Keep the tone encouraging.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const critique = result.candidates[0].content.parts[0].text;
                responseArea.innerHTML = `
                    <div class="p-4 bg-gray-900/50 border border-gray-700 rounded-lg text-left">
                        <p class="text-gray-300">${critique.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            } catch (err) {
                responseArea.innerHTML = `<p class="text-xs text-red-400">Sorry, I couldn't critique the code right now. ${err.message}</p>`;
            }
        }
        
        /**
         * Handles the Interest Quiz feature.
         */
        async function handleInterestQuiz() {
            showLoader('Creating a quiz to discover your interests...', featureModalContent);
            featureModalOverlay.classList.add('visible');

            const prompt = `Create a 5-question multiple-choice quiz designed to help a user discover a new skill to learn. The questions should be about their personality and preferences (e.g., problem-solving vs. creating, working with data vs. people). Each question should have 3-4 options. Return a JSON object with a 'quiz' array. Each item in the array should have a 'question', an array of 'options', and the 'correctAnswer' (the text of the correct option).`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            quiz: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        question: { type: "STRING" },
                                        options: { type: "ARRAY", items: { type: "STRING" } },
                                        correctAnswer: { type: "STRING" }
                                    },
                                    required: ["question", "options", "correctAnswer"]
                                }
                            }
                        },
                        required: ["quiz"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                displayInterestQuiz(data.quiz);
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not generate the quiz. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }

        /**
         * Renders the interactive interest quiz in the modal.
         * @param {Array<object>} quizData The array of quiz questions.
         */
        function displayInterestQuiz(quizData) {
            let quizHtml = `
                <h2 class="text-2xl font-bold text-white mb-6 text-center" style="font-family: 'Orbitron', sans-serif;">Discover Your Interests</h2>
                <div id="quiz-container">
            `;
            quizData.forEach((q, index) => {
                quizHtml += `
                    <div class="mb-6 quiz-question">
                        <p class="font-semibold mb-3">${index + 1}. ${q.question}</p>
                        <div class="quiz-options">
                            ${q.options.map(opt => `<button class="quiz-option w-full text-left">${opt}</button>`).join('')}
                        </div>
                    </div>
                `;
            });
            quizHtml += `</div>
                <div id="interest-quiz-results-area" class="mt-4"></div>
                <div class="text-center mt-6">
                    <button id="submit-interest-quiz-btn" class="dynamic-button">Get My Suggested Interest</button>
                </div>
            `;
            featureModalContent.innerHTML = quizHtml;
        }

        /**
         * Fetches a suggestion based on interest quiz answers.
         * @param {Array<object>} answers The user's answers.
         */
        async function fetchInterestSuggestion(answers) {
            const resultsArea = document.getElementById('interest-quiz-results-area');
            showLoader('Analyzing your answers...', resultsArea);

            const answersString = answers.map(a => `Question: "${a.question}" - Answer: "${a.answer}"`).join('\n');
            const prompt = `Based on the following quiz answers, suggest one main interest or learning domain for the user. Also provide two alternative suggestions. The goal is to populate an "interests" input field for a learning app. Keep the suggestions concise (2-3 words). Format the response as a JSON object with a 'suggestions' array. Each object in the array should have a 'domain' (string) and a 'reason' (string, 1 sentence). The first item in the array should be the top recommendation.\n\nAnswers:\n${answersString}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            suggestions: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        domain: { type: "STRING" },
                                        reason: { type: "STRING" }
                                    },
                                    required: ["domain", "reason"]
                                }
                            }
                        },
                        required: ["suggestions"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                if (data.suggestions && data.suggestions.length > 0) {
                    const topSuggestion = data.suggestions[0].domain;
                    interestsInput.value = topSuggestion;

                    let resultsHtml = `<div class="p-4 bg-gray-900/50 border border-teal-500 rounded-lg text-left">
                        <h4 class="font-bold text-lg text-white mb-3">Here are some suggested interests for you:</h4>
                        <ul class="space-y-3">`;

                    data.suggestions.forEach((sugg, index) => {
                         resultsHtml += `<li><strong class="text-teal-300">${index === 0 ? 'Top Suggestion:' : 'Alternative:'}</strong> ${sugg.domain} - <span class="text-gray-400">${sugg.reason}</span></li>`;
                    });

                    resultsHtml += `</ul><p class="text-center text-sm mt-4 text-gray-500">I've filled in the top suggestion for you. You can now close this and discover your path!</p></div>`;
                    resultsArea.innerHTML = resultsHtml;

                    document.getElementById('submit-interest-quiz-btn').style.display = 'none';

                } else {
                     resultsArea.innerHTML = `<p class="text-red-400 text-center">Couldn't determine a suggestion. Please try the quiz again.</p>`;
                }
            } catch (err) {
                 resultsArea.innerHTML = `<p class="text-red-400 text-center">Error analyzing results: ${err.message}</p>`;
            }
        }


        /**
         * Fetches and displays AI-generated flashcards.
         * @param {string} skillName The skill being learned.
         * @param {string} weekTheme The theme for the flashcards.
         */
        async function handleGetFlashcards(skillName, weekTheme) {
            featureModalOverlay.classList.add('visible');
            
            // Check cache first for instant loading
            if (prefetchCache.flashcards) {
                console.log('âš¡ Loading Flashcards from cache (instant)');
                const data = prefetchCache.flashcards;
                let flashcardsHtml = `
                    <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">Flashcards: ${weekTheme}</h2>
                    <p class="text-center text-gray-400 mb-6">Click a card to flip it over.</p>
                    <div class="flashcard-grid">
                `;
                data.flashcards.forEach(card => {
                    flashcardsHtml += `
                        <div class="flashcard">
                            <div class="flashcard-inner">
                                <div class="flashcard-front">
                                    <h3 class="text-lg font-semibold text-white">${card.term}</h3>
                                </div>
                                <div class="flashcard-back">
                                    <p class="text-gray-300">${card.definition}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                flashcardsHtml += `
                    </div>
                    <div class="text-center mt-6">
                        <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                    </div>
                `;
                featureModalContent.innerHTML = flashcardsHtml;
                return;
            }
            
            showLoader(`Generating flashcards for ${weekTheme}...`, featureModalContent);

            const prompt = `You are an AI tutor. For a beginner learning '${skillName}', create a set of 4-6 flashcards for the topic '${weekTheme}'. Each flashcard should have a 'term' (a key concept or keyword) and a 'definition' (a simple, concise explanation). Return this as a JSON object with a 'flashcards' array.`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            flashcards: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        term: { type: "STRING" },
                                        definition: { type: "STRING" }
                                    },
                                    required: ["term", "definition"]
                                }
                            }
                        },
                        required: ["flashcards"]
                    }
                }
            };
            
            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                let flashcardsHtml = `
                    <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">Flashcards: ${weekTheme}</h2>
                    <p class="text-center text-gray-400 mb-6">Click a card to flip it over.</p>
                    <div class="flashcard-grid">
                `;
                data.flashcards.forEach(card => {
                    flashcardsHtml += `
                        <div class="flashcard">
                            <div class="flashcard-inner">
                                <div class="flashcard-front">${card.term}</div>
                                <div class="flashcard-back">${card.definition}</div>
                            </div>
                        </div>
                    `;
                });
                flashcardsHtml += `</div>
                    <div class="text-center mt-8">
                        <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                    </div>
                `;
                featureModalContent.innerHTML = flashcardsHtml;
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not generate flashcards. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }

        /**
         * Handles the Study Session Planner feature.
         */
        function handleStudySessionPlanner() {
            if (!roadmapData) return;
            const skillName = roadmapData.skill;
            let html = `
                <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">Plan a Study Session</h2>
                <p class="text-center text-gray-400 mb-4">Let's schedule a focused learning block for "${skillName}".</p>
                <div class="space-y-4">
                    <div>
                        <label for="study-topic-input" class="block text-sm font-medium text-gray-300 mb-2">What specific topic will you study?</label>
                        <input id="study-topic-input" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition text-white placeholder-gray-500" type="text" placeholder="e.g., CSS Flexbox, Python Dictionaries">
                    </div>
                    <div>
                        <label for="study-duration-input" class="block text-sm font-medium text-gray-300 mb-2">How long is your session (in minutes)?</label>
                        <input id="study-duration-input" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition text-white" type="number" value="60" min="30" max="180" step="15">
                    </div>
                </div>
                <div id="study-plan-response-area" class="mt-4"></div>
                <div class="text-center mt-6">
                    <button id="submit-study-plan-btn" data-skill-name="${skillName}" class="dynamic-button">Generate Plan</button>
                </div>
            `;
            featureModalContent.innerHTML = html;
            featureModalOverlay.classList.add('visible');
        }

        /**
         * Fetches and displays a structured study plan.
         * @param {string} skillName The overall skill.
         * @param {string} topic The specific topic for the session.
         * @param {string} duration The duration of the session in minutes.
         */
        async function fetchStudyPlan(skillName, topic, duration) {
            const responseArea = document.getElementById('study-plan-response-area');
            
            // Check cache first for instant loading
            if (prefetchCache.studyPlan) {
                console.log('âš¡ Loading Study Plan from cache (instant)');
                const data = prefetchCache.studyPlan;
                let planHtml = `
                    <div class="p-4 bg-gray-900/50 border border-gray-700 rounded-lg text-left">
                        <h3 class="font-bold text-lg text-white mb-3">Your Focused Study Plan:</h3>
                        <ul class="space-y-2">
                `;
                data.plan.forEach(item => {
                    planHtml += `
                            <li class="flex items-center">
                                <span class="font-bold text-blue-400 w-20">${item.duration_minutes} mins:</span>
                                <span class="text-gray-300">${item.activity}</span>
                            </li>
                    `;
                });
                planHtml += `</ul></div>`;
                responseArea.innerHTML = planHtml;
                return;
            }
            
            showLoader(`Building your ${duration}-minute study plan...`, responseArea);

            const prompt = `Create a structured study plan for a ${duration}-minute session. The user is learning '${skillName}' and wants to focus on '${topic}'. The plan should break down the session into timed activities, including at least one short break. Use the Pomodoro technique as inspiration. Return a JSON object with a 'plan' array. Each object in the array should have 'activity' (string) and 'duration_minutes' (number).`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            plan: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        activity: { type: "STRING" },
                                        duration_minutes: { type: "NUMBER" }
                                    },
                                    required: ["activity", "duration_minutes"]
                                }
                            }
                        },
                        required: ["plan"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                prefetchCache.studyPlan = data; // Cache for future use
                let planHtml = `
                    <div class="p-4 bg-gray-900/50 border border-gray-700 rounded-lg text-left">
                        <h3 class="font-bold text-lg text-white mb-3">Your Focused Study Plan:</h3>
                        <ul class="space-y-2">
                `;
                data.plan.forEach(item => {
                    planHtml += `
                            <li class="flex items-center">
                                <span class="font-bold text-blue-400 w-20">${item.duration_minutes} mins:</span>
                                <span class="text-gray-300">${item.activity}</span>
                            </li>
                    `;
                });
                planHtml += `</ul></div>`;
                responseArea.innerHTML = planHtml;
            } catch (err) {
                responseArea.innerHTML = `<p class="text-xs text-red-400">Sorry, I couldn't generate a study plan right now. ${err.message}</p>`;
            }
        }

        /**
         * Handles narrating the roadmap summary using TTS.
         */
        async function handleNarrateRoadmap() {
            if (!roadmapData) return;
            const narrateBtn = document.getElementById('narrate-roadmap-btn');
            narrateBtn.disabled = true;
            narrateBtn.textContent = '...';

            try {
                const summaryPrompt = `You are an encouraging AI learning coach. The user has a ${roadmapData.roadmap.length}-week learning plan for '${roadmapData.skill}'. Briefly summarize the journey ahead, highlighting the key themes for the first few weeks and the exciting projects they'll be able to build by the end. Keep it under 100 words and make it sound exciting.`;
                
                const ttsPayload = {
                    contents: [{ parts: [{ text: `Say with an upbeat and encouraging tone: ${summaryPrompt}` }] }],
                    generationConfig: { responseModalities: ["AUDIO"] },
                    model: "gemini-2.5-flash"
                };

                const audioResponse = await fetchFromGeminiApi("gemini-2.5-flash", ttsPayload, apiKey1);
                const sampleRateMatch = audioResponse.mimeType.match(/rate=(\d+)/);
                
                if (audioResponse.audioData && sampleRateMatch) {
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    const pcmData = base64ToArrayBuffer(audioResponse.audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, 1, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    currentNarration = audio;
                    audio.play();
                } else {
                    throw new Error("Invalid audio data received from API.");
                }

                featureModalContent.innerHTML = `
                        <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">Your Learning Journey ðŸŽ§</h2>
                        <div class="p-4 bg-gray-900/50 border border-gray-700 rounded-lg text-left">
                            <p class="text-gray-300">${summaryText}</p>
                            <p class="text-sm text-yellow-400 mt-2">Playing the narrated summary...</p>
                        </div>
                        <div class="text-center mt-6">
                            <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                        </div>
                `;
                featureModalOverlay.classList.add('visible');

            } catch (err) {
                showError(`Narration failed: ${err.message}`);
                narrateBtn.textContent = 'ðŸŽ§'; // Reset button text
            } finally {
                narrateBtn.disabled = false;
            }
        }
        
        // --- TTS Helper Functions ---

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // --- Mock Interview Functions ---

        async function handleMockInterviewStart(skillName, careerTitle) {
            featureModalOverlay.classList.add('visible');
            
            // Check cache first for instant loading
            if (prefetchCache.mockInterview) {
                console.log('âš¡ Loading Mock Interview from cache (instant)');
                currentInterviewQuestions = prefetchCache.mockInterview.interviewQuestions;
                currentInterviewQuestionIndex = 0;
                displayCurrentInterviewQuestion();
                return;
            }
            
            showLoader(`Preparing your mock interview for a ${careerTitle}...`, featureModalContent);

            const prompt = `Generate 3 common interview questions for a '${careerTitle}' role that specifically test the candidate's knowledge of '${skillName}'. Return this as a JSON object with an 'interviewQuestions' array of strings.`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            interviewQuestions: {
                                type: "ARRAY",
                                items: { type: "STRING" }
                            }
                        },
                        required: ["interviewQuestions"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                prefetchCache.mockInterview = data; // Cache for future use
                currentInterviewQuestions = data.interviewQuestions;
                currentInterviewQuestionIndex = 0;
                displayCurrentInterviewQuestion();
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not generate interview questions. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }

        function displayCurrentInterviewQuestion() {
            const question = currentInterviewQuestions[currentInterviewQuestionIndex];
            const isLastQuestion = currentInterviewQuestionIndex === currentInterviewQuestions.length - 1;

            let html = `
                <h2 class="text-2xl font-bold text-white mb-2 text-center" style="font-family: 'Orbitron', sans-serif;">Mock Interview</h2>
                <p class="text-center text-gray-400 mb-6">Question ${currentInterviewQuestionIndex + 1} of ${currentInterviewQuestions.length}</p>
                <div class="mb-6 p-4 bg-gray-900/50 border border-gray-700 rounded-lg">
                    <p class="text-gray-300 font-semibold">${question}</p>
                </div>
                <textarea id="interview-answer-input" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition text-white placeholder-gray-500" rows="6" placeholder="Type your answer here..."></textarea>
                <div id="interview-feedback-area" class="mt-4"></div>
                <div class="text-center mt-6">
                    <button id="submit-interview-answer-btn" class="dynamic-button">Submit Answer</button>
                    <button id="next-interview-question-btn" class="dynamic-button hidden">${isLastQuestion ? 'Finish Interview' : 'Next Question'}</button>
                </div>
            `;
            featureModalContent.innerHTML = html;
        }

        async function handleMockInterviewAnswer() {
            const answerInput = document.getElementById('interview-answer-input');
            const answer = answerInput.value.trim();
            if (!answer) return;

            const question = currentInterviewQuestions[currentInterviewQuestionIndex];
            const feedbackArea = document.getElementById('interview-feedback-area');
            const submitBtn = document.getElementById('submit-interview-answer-btn');
            const nextBtn = document.getElementById('next-interview-question-btn');
            
            submitBtn.disabled = true;
            showLoader('Analyzing your answer...', feedbackArea);

            const prompt = `You are a helpful and constructive hiring manager. The interview question was: "${question}". The candidate's answer is: "${answer}". Provide feedback on the answer, focusing on clarity, technical accuracy, and structure. Start with "Feedback:", and keep it concise (2-3 sentences).`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const feedback = result.candidates[0].content.parts[0].text;
                feedbackArea.innerHTML = `
                    <div class="p-4 bg-gray-900/50 border border-teal-500 rounded-lg text-left">
                        <p class="text-gray-300">${feedback.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
                submitBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');
            } catch (err) {
                feedbackArea.innerHTML = `<p class="text-xs text-red-400">Sorry, I couldn't generate feedback right now. ${err.message}</p>`;
                submitBtn.disabled = false;
            }
        }

        // --- NEW: Dynamic Feature Functions ---

        async function handleELI5(skillName, weekTheme) {
            showLoader(`Simplifying "${weekTheme}"...`, featureModalContent);
            featureModalOverlay.classList.add('visible');

            const prompt = `Explain the concept of '${weekTheme}' from the topic '${skillName}' like I'm 5 years old. Use a simple analogy.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const explanation = result.candidates[0].content.parts[0].text;
                featureModalContent.innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">ELI5: ${weekTheme}</h2>
                    <div class="p-4 bg-gray-900/50 border border-gray-700 rounded-lg text-left">
                        <p class="text-gray-300">${explanation.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="text-center mt-6">
                        <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                    </div>
                `;
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not generate the explanation. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }

        async function handleRealWorldScenario(skillName, weekTheme) {
            showLoader(`Generating a scenario for "${weekTheme}"...`, featureModalContent);
            featureModalOverlay.classList.add('visible');

            const prompt = `Create a short, real-world scenario for a beginner learning '${skillName}' to apply their knowledge of '${weekTheme}'. The response should be a JSON object with a 'scenario_title', a 'problem_statement' (1-2 sentences), and an array of 'key_tasks' (2-3 bullet points).`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            scenario_title: { type: "STRING" },
                            problem_statement: { type: "STRING" },
                            key_tasks: { type: "ARRAY", items: { type: "STRING" } }
                        },
                        required: ["scenario_title", "problem_statement", "key_tasks"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                featureModalContent.innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-4" style="font-family: 'Orbitron', sans-serif;">Real-World Scenario: ${data.scenario_title}</h2>
                    <div class="text-gray-300 space-y-4">
                        <div>
                            <h3 class="font-bold text-lg text-white mb-2">Problem Statement</h3>
                            <p>${data.problem_statement}</p>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-white mb-2">Key Tasks</h3>
                            <ul class="list-disc list-inside space-y-1">
                                ${data.key_tasks.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                    </div>
                `;
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not generate the scenario. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }
        
        async function handleLearningStyleAdapter() {
            if (!roadmapData) return;
            const newStyle = document.getElementById('dynamic-learning-style').value;
            const adapterBtn = document.getElementById('learning-style-adapter-btn');
            adapterBtn.disabled = true;
            adapterBtn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-dashed rounded-full animate-spin mx-auto"></div>';
            
            const prompt = `You are an expert curriculum adapter. Take the following JSON learning roadmap and adapt its weekly 'goals' and 'resources' to better suit a '${newStyle}' learning style. Do not change the weekly 'theme' or the number of weeks. Return the complete, adapted roadmap in the same JSON format. Roadmap: ${JSON.stringify(roadmapData.roadmap)}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                week: { type: "NUMBER" },
                                theme: { type: "STRING" },
                                goals: { type: "ARRAY", items: { type: "STRING" } },
                                resources: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            title: { type: "STRING" },
                                            searchQuery: { type: "STRING" }
                                        },
                                        required: ["title", "searchQuery"]
                                    }
                                }
                            },
                            required: ["week", "theme", "goals", "resources"]
                        }
                    }
                }
            };
            
            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const newRoadmap = JSON.parse(result.candidates[0].content.parts[0].text);
                roadmapData.roadmap = newRoadmap;
                const roadmapContainer = document.getElementById('roadmap-container');
                if(roadmapContainer) {
                    showLoader(`Adapting path to ${newStyle} style...`, roadmapContainer);
                    setTimeout(() => {
                        displayRoadmap(roadmapData);
                    }, 500);
                }
            } catch (err) {
                showError(`Failed to adapt learning style: ${err.message}`);
            } finally {
                adapterBtn.disabled = false;
                adapterBtn.textContent = 'Adapt My Path';
            }
        }

        function handleVisualizeConcept(skillName, weekTheme) {
            let html = `
                <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">Visualize a Concept ðŸŽ¨</h2>
                <p class="text-center text-gray-400 mb-4">Describe an image that represents your understanding of "${weekTheme}". Be creative!</p>
                <textarea id="visualize-input" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition text-white placeholder-gray-500" rows="3" placeholder="e.g., A group of boxes happily arranging themselves using CSS flexbox."></textarea>
                <div id="visualize-response-area" class="mt-4"></div>
                <div class="text-center mt-6">
                    <button id="submit-visualize-btn" class="dynamic-button">Generate Image</button>
                </div>
            `;
            featureModalContent.innerHTML = html;
            featureModalOverlay.classList.add('visible');
        }

        async function fetchVisualizedImage(description) {
            const responseArea = document.getElementById('visualize-response-area');
            showLoader('Generating your visualization... This may take a moment.', responseArea);

            const prompt = `Generate a visually appealing, high-quality image based on the following description: ${description}. Style: digital art, vibrant colors.`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE']
                }
            };
            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (!base64Data) {
                    throw new Error("Invalid image data received from API.");
                }
                const imageUrl = `data:image/png;base64,${base64Data}`;
                
                responseArea.innerHTML = `
                    <div class="p-2 bg-gray-900/50 border border-gray-700 rounded-lg">
                        <img src="${imageUrl}" alt="AI generated visualization" class="rounded-md w-full h-auto">
                    </div>
                `;
            } catch (err) {
                responseArea.innerHTML = `<p class="text-xs text-red-400 text-center">Sorry, I couldn't generate the image right now. ${err.message}</p>`;
            }
        }

        async function handleConceptConnector(skillName, weekTheme) {
            showLoader(`Finding connections for "${weekTheme}"...`, featureModalContent);
            featureModalOverlay.classList.add('visible');

            const prompt = `You are a creative educator. The user is learning about '${weekTheme}' in the context of '${skillName}'. Explain how this concept connects to 2-3 other surprising fields or real-world ideas. For example, connect programming loops to music composition or history. Return a JSON object with a 'connections' array. Each item should have a 'field' (e.g., 'Music') and a 'explanation' (a simple, interesting parallel).`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            connections: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        field: { type: "STRING" },
                                        explanation: { type: "STRING" }
                                    },
                                    required: ["field", "explanation"]
                                }
                            }
                        },
                        required: ["connections"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                let html = `
                    <h2 class="text-2xl font-bold text-white mb-4" style="font-family: 'Orbitron', sans-serif;">Concept Connector: ${weekTheme}</h2>
                    <div class="space-y-4">
                `;
                data.connections.forEach(conn => {
                    html += `
                        <div class="p-4 bg-gray-900/50 border-l-4 border-purple-500 rounded-r-lg">
                            <h3 class="font-bold text-lg text-purple-300">${conn.field}</h3>
                            <p class="text-gray-300 mt-1">${conn.explanation}</p>
                        </div>
                    `;
                });
                html += `</div>
                    <div class="text-center mt-6">
                        <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                    </div>
                `;
                featureModalContent.innerHTML = html;
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not find connections. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }

        async function handleCareerRecommender() {
            showLoader(`Recommending a career path...`, featureModalContent);
            featureModalOverlay.classList.add('visible');
            
            const skills = skillsInput.value.trim();
            const interests = interestsInput.value.trim();
            const pursuingClassInput = document.querySelector('input[name="pursuing-class"]:checked');
            const pursuingClass = pursuingClassInput ? pursuingClassInput.value : 'Graduation';
            const streamInput = document.querySelector('input[name="stream"]:checked');
            const stream = streamInput ? streamInput.value : 'Not specified';

            const prompt = `Based on a user in '${pursuingClass}' ('${stream}' stream) with skills in '${skills}' and interests in '${interests}', recommend one specific career path. Provide the response as a JSON object with a 'career_title', a 'reason' (why it's a good fit, 2 sentences), and an array of 'next_steps' (3 actionable steps to start pursuing this career).`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            career_title: { type: "STRING" },
                            reason: { type: "STRING" },
                            next_steps: { type: "ARRAY", items: { type: "STRING" } }
                        },
                        required: ["career_title", "reason", "next_steps"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                let html = `
                    <h2 class="text-2xl font-bold text-white mb-4" style="font-family: 'Orbitron', sans-serif;">Career Recommendation</h2>
                    <div class="p-4 bg-gray-900/50 border border-amber-500 rounded-lg">
                        <h3 class="text-xl font-bold text-amber-300">${data.career_title}</h3>
                        <p class="text-gray-300 mt-2 mb-4">${data.reason}</p>
                        <h4 class="font-bold text-lg text-white mb-2">Your Next Steps:</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-400">
                            ${data.next_steps.map(step => `<li>${step}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="text-center mt-6">
                        <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                    </div>
                `;
                featureModalContent.innerHTML = html;
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not generate a career recommendation. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }
        
        // --- NEW: Offline Centers ---
        
        /**
         * Fetches and displays suggestions for offline learning centers.
         * @param {string} skillName The skill to search for.
         */
        async function handleOfflineCenterSearch(skillName) {
            const centersBtn = document.getElementById('offline-centers-btn');
            const resultsContainer = document.getElementById('offline-centers-results');
            centersBtn.disabled = true;
            
            // Check prefetch cache first
            if (prefetchCache.offlineCenters) {
                const data = prefetchCache.offlineCenters;
                let centersHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">';
                data.centers.forEach(center => {
                    centersHtml += `
                        <a href="https://www.google.com/search?q=${encodeURIComponent(center.searchQuery)}" target="_blank" rel="noopener noreferrer" class="block offline-center-card glass-card p-4 border-l-4 border-teal-500 cursor-pointer transition-transform hover:scale-105">
                            <h4 class="font-bold text-teal-300 pointer-events-none">${center.name}</h4>
                            <p class="text-sm text-gray-400 mt-1 pointer-events-none">${center.description}</p>
                        </a>
                    `;
                });
                centersHtml += '</div>';
                resultsContainer.innerHTML = centersHtml;
                centersBtn.style.display = 'none';
                return;
            }
            
            showLoader(`Searching for offline learning options for ${skillName}...`, resultsContainer);

            const prompt = `For a user learning '${skillName}', suggest 3-4 types of physical, offline places they could find courses or workshops. For each suggestion, provide a 'name' (e.g., 'Local Community Colleges') and a concise 'description' (1 sentence). Also provide a 'searchQuery' which is a generic Google search query a user could run to find these places near them (e.g., "'${skillName}' course at community college near me").`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            centers: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        description: { type: "STRING" },
                                        searchQuery: { type: "STRING" }
                                    },
                                    required: ["name", "description", "searchQuery"]
                                }
                            }
                        },
                        required: ["centers"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                let centersHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">';
                data.centers.forEach(center => {
                    centersHtml += `
                        <a href="https://www.google.com/search?q=${encodeURIComponent(center.searchQuery)}" target="_blank" rel="noopener noreferrer" class="block offline-center-card glass-card p-4 border-l-4 border-teal-500 cursor-pointer transition-transform hover:scale-105">
                            <h4 class="font-bold text-teal-300 pointer-events-none">${center.name}</h4>
                            <p class="text-sm text-gray-400 mt-1 pointer-events-none">${center.description}</p>
                        </a>
                    `;
                });
                centersHtml += '</div>';
                resultsContainer.innerHTML = centersHtml;
            } catch (err) {
                resultsContainer.innerHTML = `<p class="text-red-400 text-center">Could not fetch offline center suggestions. ${err.message}</p>`;
            } finally {
                centersBtn.style.display = 'none'; // Hide button after use
            }
        }

        // --- NEW: Timeline Tracker Functions ---
        
        /**
         * Fetches and displays a timeline of important academic/career dates.
         */
        async function handleTimelineTracker() {
            featureModalOverlay.classList.add('visible');
            
            // Check prefetch cache first
            if (prefetchCache.academicTimeline) {
                const data = prefetchCache.academicTimeline;
                displayTimelineTracker(data.timelineEvents);
                return;
            }
            
            showLoader(`Generating your personalized timeline...`, featureModalContent);

            const pursuingClass = document.querySelector('input[name="pursuing-class"]:checked')?.value || 'Graduation';
            const stream = document.querySelector('input[name="stream"]:checked')?.value || 'General';

            const prompt = `You are an academic advisor AI. A user in India who is in '${pursuingClass}' with a focus on the '${stream}' stream is learning about '${selectedSkill}'. Based on the current date being September 22, 2025, generate a timeline of important upcoming academic and career-related events for them for the next 6-8 months. Include application deadlines for top entrance exams, university admissions, popular scholarships, and counseling schedules relevant to their field and level in India.

            Return a JSON object with a 'timelineEvents' array. Each object in the array should have:
            1. 'eventName': The name of the event (e.g., "JEE Main 2026 Session 1 Application").
            2. 'eventType': The category (e.g., "Entrance Exam", "Admission", "Scholarship", "Counseling").
            3. 'estimatedDate': A likely date or date range for the event (e.g., "November 2025", "Jan 15, 2026").
            4. 'description': A brief 1-sentence description of the event.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            timelineEvents: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        eventName: { type: "STRING" },
                                        eventType: { type: "STRING" },
                                        estimatedDate: { type: "STRING" },
                                        description: { type: "STRING" }
                                    },
                                    required: ["eventName", "eventType", "estimatedDate", "description"]
                                }
                            }
                        },
                        required: ["timelineEvents"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                displayTimelineTracker(data.timelineEvents);
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not generate the timeline. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }

        /**
         * Renders the timeline tracker in the modal.
         * @param {Array<object>} events The array of timeline events.
         */
        function displayTimelineTracker(events) {
            const groupedEvents = events.reduce((acc, event) => {
                const { eventType } = event;
                if (!acc[eventType]) {
                    acc[eventType] = [];
                }
                acc[eventType].push(event);
                return acc;
            }, {});

            let timelineHtml = `
                <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">ðŸ“… Your Academic Timeline</h2>
                <div class="space-y-6">
            `;
            
            for (const eventType in groupedEvents) {
                timelineHtml += `
                    <div>
                        <h3 class="text-xl font-bold text-white mb-3 border-b-2 border-blue-400 pb-1">${eventType}</h3>
                        <ul class="space-y-3">
                `;
                groupedEvents[eventType].forEach(event => {
                    timelineHtml += `
                        <li class="p-3 bg-gray-900/50 rounded-lg">
                            <p class="font-semibold text-gray-300">${event.eventName}</p>
                            <p class="text-sm text-blue-400 font-medium">${event.estimatedDate}</p>
                            <p class="text-xs text-gray-400 mt-1">${event.description}</p>
                        </li>
                    `;
                });
                timelineHtml += `</ul></div>`;
            }
            const searchQuery = `${selectedSkill} ${document.querySelector('input[name="pursuing-class"]:checked')?.value} important dates official website`;
            timelineHtml += `
                </div>
                <div class="text-center mt-8">
                    <a href="https://www.google.com/search?q=${encodeURIComponent(searchQuery)}" target="_blank" rel="noopener noreferrer" class="dynamic-button">
                        Find Official Dates & More Info
                    </a>
                    <button class="close-modal-btn dynamic-button secondary-button ml-2">Close</button>
                </div>
            `;
            featureModalContent.innerHTML = timelineHtml;
        }

        /**
         * Handles the learning milestones feature using prefetch cache
         */
        async function handleLearningMilestones() {
            featureModalOverlay.classList.add('visible');
            
            // Check prefetch cache first
            if (prefetchCache.timelineTracker) {
                const data = prefetchCache.timelineTracker;
                displayLearningMilestones(data.milestones);
                return;
            }
            
            showLoader(`Generating learning milestones...`, featureModalContent);
            
            // If not cached, fetch it
            const prompt = `Create a milestone-based timeline for mastering '${selectedSkill}' with 5 key checkpoints and estimated timeframes.`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            milestones: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        title: { type: "STRING" },
                                        description: { type: "STRING" },
                                        timeframe: { type: "STRING" }
                                    }
                                }
                            }
                        }
                    }
                }
            };
            
            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey());
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                displayLearningMilestones(data.milestones);
            } catch (err) {
                featureModalContent.innerHTML = `<p class="text-red-400">Could not generate milestones. ${err.message}</p> <div class="text-center mt-6"><button class="close-modal-btn dynamic-button secondary-button">Close</button></div>`;
            }
        }
        
        /**
         * Renders the learning milestones in the modal.
         * @param {Array<object>} milestones The array of milestone objects.
         */
        function displayLearningMilestones(milestones) {
            let timelineHtml = `
                <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">ðŸŽ¯ ${selectedSkill} Learning Milestones</h2>
                <p class="text-center text-gray-400 mb-6 text-sm">Key checkpoints on your learning journey</p>
                <div class="space-y-4">
            `;
            
            milestones.forEach((milestone, index) => {
                timelineHtml += `
                    <div class="p-4 bg-gray-900/50 rounded-lg border-l-4 border-blue-400 hover:border-blue-300 transition-colors">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">${index + 1}</div>
                            <h3 class="font-bold text-white text-lg">${milestone.title}</h3>
                        </div>
                        <p class="text-gray-300 text-sm ml-11 mb-2">${milestone.description}</p>
                        <p class="text-blue-400 text-xs ml-11 font-semibold">â±ï¸ ${milestone.timeframe}</p>
                    </div>
                `;
            });
            
            timelineHtml += `
                </div>
                <div class="text-center mt-8">
                    <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                </div>
            `;
            featureModalContent.innerHTML = timelineHtml;
        }

        // --- NEW: Debate Feature Functions ---

        /**
         * Initiates the debate feature by getting a topic and opening statement.
         * @param {string} skillName The skill being learned.
         * @param {string} weekTheme The theme of the week's topic.
         */
        async function handleDebateTopic(skillName, weekTheme) {
            const debateModalContent = document.getElementById('debate-modal-content');
            showLoader(`Generating a debate topic for "${weekTheme}"...`, debateModalContent);
            debateModalOverlay.classList.add('visible');

            const prompt = `You are an AI that plays the role of a debate antagonist. For a beginner learning about '${skillName}', generate a controversial but debatable topic related to '${weekTheme}'. The topic should challenge a common assumption. Then, provide a strong opening argument for your side (the 'antagonist' side). Return a JSON object with 'topic' (string) and 'opening_statement' (string).`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            topic: { type: "STRING" },
                            opening_statement: { type: "STRING" }
                        },
                        required: ["topic", "opening_statement"]
                    }
                }
            };

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                debateHistory = [{ role: "model", parts: [{ text: data.opening_statement }] }];
                
                debateModalContent.innerHTML = `
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                        <div>
                            <h2 class="text-lg font-bold text-white" style="font-family: 'Orbitron', sans-serif;">Debate Arena âš”ï¸</h2>
                            <p class="text-sm text-gray-400">${data.topic}</p>
                        </div>
                        <button id="close-debate-btn" class="text-gray-400 hover:text-white transition-colors">
                            <ion-icon name="close-circle-outline" class="text-2xl"></ion-icon>
                        </button>
                    </div>
                    <div id="debate-messages" class="flex-grow p-4 overflow-y-auto">
                        <div class="chat-message model">
                            <div class="chat-bubble model debate-antagonist">${data.opening_statement.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-700">
                        <form id="debate-form" class="flex gap-2">
                            <input id="debate-input" type="text" placeholder="Your rebuttal..." class="flex-grow px-4 py-2 bg-gray-800/50 border border-gray-600 rounded-full focus:ring-2 focus:ring-blue-400 focus:border-transparent transition text-white placeholder-gray-500" autocomplete="off">
                            <button type="submit" id="debate-send-btn" class="dynamic-button !p-3 !rounded-full flex items-center justify-center">
                                <ion-icon name="send-outline" class="text-xl"></ion-icon>
                            </button>
                        </form>
                    </div>
                `;
            } catch (err) {
                debateModalContent.innerHTML = `<p class="text-red-400 p-4">Could not generate a debate topic. ${err.message}</p> <div class="text-center p-4"><button id="close-debate-btn" class="dynamic-button secondary-button">Close</button></div>`;
            }
        }

        /**
         * Handles the user's rebuttal in the debate.
         * @param {Event} event The form submission event.
         */
        async function handleDebateRebuttal(event) {
            event.preventDefault();
            const debateInput = document.getElementById('debate-input');
            const debateSendBtn = document.getElementById('debate-send-btn');
            const debateMessages = document.getElementById('debate-messages');
            const userInput = debateInput.value.trim();

            if (!userInput) return;

            debateMessages.innerHTML += `
                <div class="chat-message user">
                    <div class="chat-bubble user">${userInput}</div>
                </div>`;
            debateMessages.scrollTop = debateMessages.scrollHeight;
            debateInput.value = '';
            debateSendBtn.disabled = true;

            debateMessages.innerHTML += `
                <div class="chat-message model" id="debate-thinking-indicator">
                    <div class="chat-bubble model debate-antagonist">
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0s;"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                        </div>
                    </div>
                </div>`;
            debateMessages.scrollTop = debateMessages.scrollHeight;

            debateHistory.push({ role: "user", parts: [{ text: userInput }] });

            const systemPrompt = "You are a sharp and intelligent debate antagonist. Provide a concise, challenging, but respectful counter-argument to the user's last point. Stay in character.";
            const payload = {
                contents: debateHistory,
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };
            

            try {
                const result = await fetchFromGeminiApi('gemini-2.5-flash', payload, getBackgroundApiKey()); // Use background key
                const responseText = result.candidates[0].content.parts[0].text;
                debateHistory.push({ role: "model", parts: [{ text: responseText }] });
                
                document.getElementById('debate-thinking-indicator').remove();
                debateMessages.innerHTML += `
                    <div class="chat-message model">
                        <div class="chat-bubble model debate-antagonist">${responseText.replace(/\n/g, '<br>')}</div>
                    </div>`;
            } catch (err) {
                document.getElementById('debate-thinking-indicator').remove();
                debateMessages.innerHTML += `
                    <div class="chat-message model">
                        <div class="chat-bubble model debate-antagonist text-red-400">I seem to have lost my train of thought. Please try your rebuttal again.</div>
                    </div>`;
            } finally {
                debateSendBtn.disabled = false;
                debateMessages.scrollTop = debateMessages.scrollHeight;
            }
        }
        
        async function handleGetEducationNews() {
            console.log('ðŸ“° Starting education news fetch...');
            if (!newsApiKey || newsApiKey === "YOUR_NEWSDATA_API_KEY") {
                console.error('âŒ News API key not configured');
                showError("News API key is not configured. This feature is unavailable.");
                return;
            }
            console.log('âœ… News API key configured, proceeding...');
            const academicLevel = document.querySelector('input[name="pursuing-class"]:checked')?.value || 'Graduation';
            const newsTopic = academicLevel !== 'Graduation' ? `${academicLevel} education India` : 'higher education India';
            
            // Re-render the modal structure with a loading state first
            featureModalContent.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">Latest Education News ðŸ“°</h2>
                <div id="news-loading-area" class="text-center p-8">
                    <div class="flex justify-center items-center">
                        <div class="w-8 h-8 border-4 border-dashed rounded-full animate-spin" style="border-top-color: var(--primary-glow); border-left-color: var(--primary-glow); border-right-color: transparent; border-bottom-color: transparent;"></div>
                    </div>
                    <p class="mt-4 text-gray-300 font-medium">Fetching the latest education news for ${academicLevel}...</p>
                </div>
            `;
            featureModalOverlay.classList.add('visible');

            // Fetch real news data from NewsData.io API
            let newsData = null;
            
            try {
                console.log('ðŸ“° Fetching education news for:', newsTopic);
                const newsUrl = `https://newsdata.io/api/1/news?apikey=${newsApiKey}&q=${encodeURIComponent(newsTopic)}&language=en&category=education&size=5`;
                const newsResponse = await fetch(newsUrl);
                
                if (!newsResponse.ok) {
                    throw new Error(`News API error: ${newsResponse.status}`);
                }
                
                const apiResult = await newsResponse.json();
                
                if (!apiResult.results || apiResult.results.length === 0) {
                    throw new Error('No news articles found');
                }
                
                // Map API results to our format
                newsData = apiResult.results.slice(0, 4).map(article => ({
                    title: article.title || 'Untitled Article',
                    description: article.description || article.content || 'No description available',
                    link: article.link || '#',
                    source: article.source_id || 'Unknown Source',
                    pubDate: article.pubDate || ''
                }));
                
                console.log('âœ… News data fetched successfully:', newsData.length, 'articles');
                
            } catch (err) {
                console.warn('âš ï¸ News API failed, using fallback:', err.message);
                
                // Fallback news when API fails
                newsData = [
                    {
                        title: `Education Policy Updates for ${academicLevel} Students`,
                        description: `Recent developments in education policy affecting ${academicLevel} students across India. Stay informed about new opportunities and changes.`,
                        link: `https://news.google.com/search?q=education+policy+${academicLevel}+India`,
                        source: 'Education News',
                        isFallback: true
                    },
                    {
                        title: `Technology Integration in ${academicLevel} Curriculum`,
                        description: `How modern technology and AI are being incorporated into ${academicLevel} education systems to prepare students for the digital future.`,
                        link: `https://news.google.com/search?q=technology+education+${academicLevel}+curriculum`,
                        source: 'EdTech News',
                        isFallback: true
                    },
                    {
                        title: `Scholarship Opportunities for ${academicLevel} Students`,
                        description: `Latest scholarship programs and financial aid opportunities available for ${academicLevel} students pursuing higher education.`,
                        link: `https://news.google.com/search?q=scholarships+${academicLevel}+students+India`,
                        source: 'Education Finance',
                        isFallback: true
                    },
                    {
                        title: `Career Guidance for ${academicLevel} Students`,
                        description: `Expert advice and career counseling resources to help ${academicLevel} students make informed decisions about their future.`,
                        link: `https://news.google.com/search?q=career+guidance+${academicLevel}+students`,
                        source: 'Career News',
                        isFallback: true
                    }
                ];
            }
            
            // Build the news HTML
            let newsHtml = `
                <h2 class="text-2xl font-bold text-white mb-4 text-center" style="font-family: 'Orbitron', sans-serif;">Latest Education News ðŸ“°</h2>
                <div class="space-y-4">
            `;

            // Add fallback notice if using offline data
            if (newsData.some(item => item.isFallback)) {
                newsHtml += `
                    <div class="mb-4 p-3 bg-yellow-900/30 border border-yellow-600/50 rounded-lg">
                        <p class="text-yellow-400 text-sm">â„¹ï¸ Showing general education news (live news service temporarily unavailable)</p>
                    </div>
                `;
            }
            
            newsData.forEach(newsItem => {
                const truncatedDesc = newsItem.description.length > 150 ? 
                    newsItem.description.substring(0, 150) + '...' : newsItem.description;
                    
                newsHtml += `
                    <a href="${newsItem.link}" target="_blank" rel="noopener noreferrer" class="block p-4 bg-gray-800/50 rounded-lg border border-gray-700 hover:bg-gray-700/70 hover:border-white transition">
                        <h4 class="font-bold text-white">${newsItem.title}</h4>
                        <p class="text-sm text-gray-400 mt-1">${truncatedDesc}</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-gray-500">${newsItem.source}</span>
                            <span class="text-xs text-blue-400">Read more â†’</span>
                        </div>
                    </a>
                `;
            });
            
            newsHtml += `</div>
                <div class="text-center mt-6">
                    <button id="refresh-news-btn" class="dynamic-button secondary-button mr-4">Refresh News</button>
                    <button class="close-modal-btn dynamic-button secondary-button">Close</button>
                </div>
            `;
            
            featureModalContent.innerHTML = newsHtml;

            // Attach the listener to the newly created button
            document.getElementById('refresh-news-btn').addEventListener('click', handleGetEducationNews);
        }


        // --- Event Listeners ---
        
        getSuggestionsBtn.addEventListener('click', handleGetSuggestions);
        document.getElementById('chat-form').addEventListener('submit', handleChatMessage);
        interestQuizBtn.addEventListener('click', handleInterestQuiz);

        document.getElementById('input-section').addEventListener('click', (event) => {
            const analyzerBtn = event.target.closest('#learning-style-analyzer-btn');
            if (analyzerBtn) {
                // handleLearningStyleAnalyzer(); // This feature is not implemented yet
                alert('This feature is coming soon!');
            }
        });

        resultsArea.addEventListener('click', (event) => {
            const link = event.target.closest('a');
            if (link) {
                // If a link is clicked, let the browser handle it.
                return;
            }

            const suggestionCard = event.target.closest('.suggestion-card');
            const timePlanBtn = event.target.closest('.time-plan-btn');
            const levelBtn = event.target.closest('.level-btn');
            const startOverBtn = event.target.closest('#start-over-btn');
            const deepDiveBtn = event.target.closest('#deep-dive-btn');
            const careerExplorerBtn = event.target.closest('#career-explorer-btn');
            const careerCard = event.target.closest('.career-card');
            const suggestProjectBtn = event.target.closest('#suggest-project-btn');
            const refreshSuggestionsBtn = event.target.closest('#refresh-suggestions-btn');
            const setupGuideBtn = event.target.closest('#setup-guide-btn');
            const quizMeBtn = event.target.closest('.quiz-me-btn');
            const imStuckBtn = event.target.closest('.im-stuck-btn');
            const flashcardBtn = event.target.closest('.flashcard-btn');
            const studyPlanBtn = event.target.closest('#study-plan-btn');
            const narrateBtn = event.target.closest('#narrate-roadmap-btn');
            const eli5Btn = event.target.closest('.eli5-btn');
            const scenarioBtn = event.target.closest('.scenario-btn');
            const adapterBtn = event.target.closest('#learning-style-adapter-btn');
            const visualizeBtn = event.target.closest('.visualize-btn');
            const conceptConnectorBtn = event.target.closest('.concept-connector-btn');
            const careerRecommenderBtn = event.target.closest('#career-recommender-btn');
            const debateBtn = event.target.closest('.debate-btn');
            const offlineBtn = event.target.closest('#offline-centers-btn');
            const backBtn = event.target.closest('#back-to-input-btn');
            const toggleBtn = event.target.closest('.toggle-resources-btn');
            const timelineBtn = event.target.closest('#timeline-tracker-btn');
            const milestonesBtn = event.target.closest('#milestones-btn');
            const newsButton = event.target.closest('#news-button');
            const academicSuggestorBtn = event.target.closest('#next-academic-suggestor-btn');
            
            if (suggestionCard) {
                selectedSkill = suggestionCard.dataset.skillName;
                document.getElementById('suggestions-container').classList.add('hidden');
                const timePlanSection = document.getElementById('time-plan-section');
                timePlanSection.classList.remove('hidden');
                timePlanSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            if (backBtn) {
                resetUI();
                return;
            }
            
            if (timePlanBtn) {
                selectedWeeks = timePlanBtn.dataset.weeks;
                document.getElementById('time-plan-section').classList.add('hidden');
                const levelSection = document.getElementById('level-selection-section');
                levelSection.classList.remove('hidden');
                levelSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            if (levelBtn) {
                selectedLevel = levelBtn.dataset.level;
                // Hide all selection sections immediately
                document.getElementById('suggestions-container')?.classList.add('hidden');
                document.getElementById('time-plan-section')?.classList.add('hidden');
                document.getElementById('level-selection-section')?.classList.add('hidden');
                
                if (selectedSkill && selectedWeeks && selectedLevel) {
                    handleGetRoadmap(selectedSkill, selectedWeeks, selectedLevel);
                }
                return;
            }

            if (toggleBtn) {
                toggleBtn.classList.toggle('open');
                const resourceList = toggleBtn.nextElementSibling;
                if (resourceList && resourceList.classList.contains('resource-list')) {
                    resourceList.classList.toggle('hidden');
                }
                return;
            }

            if (timelineBtn) {
                handleTimelineTracker();
                return;
            }
            
            if (milestonesBtn) {
                handleLearningMilestones();
                return;
            }

            if (newsButton) {
                console.log('ðŸ“° News button clicked!');
                handleGetEducationNews();
                return;
            }

            if (startOverBtn) {
                resetUI();
            }

            if (deepDiveBtn) {
                handleDeepDive(deepDiveBtn.dataset.skillName);
            }

            if (careerExplorerBtn) {
                handleCareerExplorer(careerExplorerBtn.dataset.skillName);
            }
            
            if (offlineBtn) {
                handleOfflineCenterSearch(offlineBtn.dataset.skillName);
            }

            if (careerCard) {
                handleCareerDeepDive(careerCard.dataset.careerTitle);
            }
            
            if (suggestProjectBtn) {
                handleProjectSuggestions(suggestProjectBtn.dataset.skillName);
            }

            if (refreshSuggestionsBtn) {
                handleGetSuggestions();
            }

            if (setupGuideBtn) {
                handleGetSetupSteps();
            }

            if (quizMeBtn) {
                handleGetQuiz(quizMeBtn.dataset.skillName, quizMeBtn.dataset.weekTheme);
            }
            
            if (imStuckBtn) {
                handleLearningBlocker(imStuckBtn.dataset.skillName, imStuckBtn.dataset.weekTheme);
            }

            if (flashcardBtn) {
                handleGetFlashcards(flashcardBtn.dataset.skillName, flashcardBtn.dataset.weekTheme);
            }

            if (studyPlanBtn) {
                handleStudySessionPlanner();
            }

            if (narrateBtn) {
                handleNarrateRoadmap();
            }

            if (eli5Btn) {
                handleELI5(eli5Btn.dataset.skillName, eli5Btn.dataset.weekTheme);
            }

            if (scenarioBtn) {
                handleRealWorldScenario(scenarioBtn.dataset.skillName, scenarioBtn.dataset.weekTheme);
            }
            
            if(adapterBtn) {
                handleLearningStyleAdapter();
            }
            
            if(visualizeBtn) {
                handleVisualizeConcept(visualizeBtn.dataset.skillName, visualizeBtn.dataset.weekTheme);
            }
            
            if(conceptConnectorBtn) {
                handleConceptConnector(conceptConnectorBtn.dataset.skillName, conceptConnectorBtn.dataset.weekTheme);
            }

            if(careerRecommenderBtn) {
                handleCareerRecommender();
            }

            if(debateBtn) {
                handleDebateTopic(debateBtn.dataset.skillName, debateBtn.dataset.weekTheme);
            }
            
            if(academicSuggestorBtn) {
                try {
                    const academicLevelInput = document.querySelector('input[name="pursuing-class"]:checked');
                    const streamInput = document.querySelector('input[name="stream"]:checked');
                    
                    if (!academicLevelInput || !streamInput) {
                        console.error('âŒ Academic level or stream not selected');
                        return;
                    }
                    
                    const academicLevel = academicLevelInput.value;
                    const currentStream = streamInput.value;
                    handleNextAcademicSuggestion(academicLevel, currentStream);
                } catch (err) {
                    console.error('âŒ Error in academic suggestor button click:', err);
                }
            }
        });
        
        aiCoachFab.addEventListener('click', (event) => {
            const skillName = event.currentTarget.dataset.skillName;
            if (skillName) {
                openAiCoachChat(skillName);
            }
        });
        
        // --- Modal Event Listeners ---

        featureModalOverlay.addEventListener('click', (event) => {
            if (event.target.id === 'feature-modal-overlay' || event.target.closest('.close-modal-btn')) {
                if (currentNarration) {
                    currentNarration.pause();
                    currentNarration.currentTime = 0;
                    currentNarration = null;
                }
                featureModalOverlay.classList.remove('visible');
            }
        });

        aiCoachChatModalOverlay.addEventListener('click', (event) => {
            if (event.target.id === 'ai-coach-chat-modal-overlay' || event.target.closest('#close-chat-btn')) {
                aiCoachChatModalOverlay.classList.remove('visible');
            }
        });
        
        debateModalOverlay.addEventListener('click', (event) => {
            if (event.target.id === 'debate-modal-overlay' || event.target.closest('#close-debate-btn')) {
                debateModalOverlay.classList.remove('visible');
            }
        });
        debateModalOverlay.addEventListener('submit', (event) => {
             if (event.target.id === 'debate-form') {
                 handleDebateRebuttal(event);
             }
        });


        featureModalContent.addEventListener('click', (event) => {
            const projectCard = event.target.closest('.project-card');
            if (projectCard) {
                handleProjectDetails(projectCard.dataset.projectTitle, projectCard.dataset.skillName);
                return;
            }

            if (event.target.closest('#next-step-btn')) {
                if (currentStepIndex < currentSetupSteps.length - 1) {
                    currentStepIndex++;
                    displaySetupStep();
                } else {
                    featureModalOverlay.classList.remove('visible');
                }
                return;
            }
            if (event.target.closest('#prev-step-btn')) {
                if (currentStepIndex > 0) {
                    currentStepIndex--;
                    displaySetupStep();
                }
                return;
            }

            const analogyBtn = event.target.closest('#analogy-btn');
            if (analogyBtn) {
                handleGetAnalogy(analogyBtn.dataset.skillName);
                return;
            }

            const mockInterviewBtn = event.target.closest('#mock-interview-btn');
            if (mockInterviewBtn) {
                handleMockInterviewStart(mockInterviewBtn.dataset.skillName, mockInterviewBtn.dataset.careerTitle);
                return;
            }

            const submitInterviewAnswerBtn = event.target.closest('#submit-interview-answer-btn');
            if(submitInterviewAnswerBtn) {
                handleMockInterviewAnswer();
                return;
            }

            const nextInterviewQuestionBtn = event.target.closest('#next-interview-question-btn');
            if(nextInterviewQuestionBtn) {
                currentInterviewQuestionIndex++;
                if (currentInterviewQuestionIndex < currentInterviewQuestions.length) {
                    displayCurrentInterviewQuestion();
                } else {
                    featureModalOverlay.classList.remove('visible');
                }
                return;
            }

            const submitBlockerBtn = event.target.closest('#submit-blocker-btn');
            if (submitBlockerBtn) {
                const blockerInput = document.getElementById('blocker-input');
                const problem = blockerInput.value.trim();
                if (problem) {
                    fetchBlockerHelp(submitBlockerBtn.dataset.skillName, submitBlockerBtn.dataset.weekTheme, problem);
                    submitBlockerBtn.disabled = true;
                }
                return;
            }

            const codeCritiqueBtn = event.target.closest('#code-critique-btn');
            if (codeCritiqueBtn) {
                handleCodeCritique(codeCritiqueBtn.dataset.skillName, codeCritiqueBtn.dataset.projectTitle);
                return;
            }

            const submitCritiqueBtn = event.target.closest('#submit-critique-btn');
            if (submitCritiqueBtn) {
                const codeInput = document.getElementById('code-input');
                const code = codeInput.value.trim();
                if (code) {
                    fetchCodeCritique(submitCritiqueBtn.dataset.skillName, submitCritiqueBtn.dataset.projectTitle, code);
                    submitCritiqueBtn.disabled = true;
                }
                return;
            }

            const submitStudyPlanBtn = event.target.closest('#submit-study-plan-btn');
            if (submitStudyPlanBtn) {
                const topicInput = document.getElementById('study-topic-input');
                const durationInput = document.getElementById('study-duration-input');
                const topic = topicInput.value.trim();
                const duration = durationInput.value;
                if (topic && duration) {
                    fetchStudyPlan(submitStudyPlanBtn.dataset.skillName, topic, duration);
                    submitStudyPlanBtn.disabled = true;
                }
                return;
            }
            
            const submitVisualizeBtn = event.target.closest('#submit-visualize-btn');
            if (submitVisualizeBtn) {
                const visualizeInput = document.getElementById('visualize-input');
                const description = visualizeInput.value.trim();
                if (description) {
                    fetchVisualizedImage(description);
                    submitVisualizeBtn.disabled = true;
                }
                return;
            }

            const analyzerOption = event.target.closest('.analyzer-option');
            if (analyzerOption) {
                styleAnalyzerAnswers.push(analyzerOption.dataset.style);
                currentStyleAnalyzerQuestionIndex++;
                if (currentStyleAnalyzerQuestionIndex < styleAnalyzerQuestions.length) {
                    displayCurrentStyleAnalyzerQuestion();
                } else {
                    analyzeStyleQuizAnswers();
                }
                return;
            }


            const quizOption = event.target.closest('.quiz-option');
            if (quizOption) {
                const optionsContainer = quizOption.parentElement;
                optionsContainer.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
                quizOption.classList.add('selected');
                return;
            }

            const submitBtn = event.target.closest('#submit-quiz-btn');
            if (submitBtn) {
                let score = 0;
                const questions = featureModalContent.querySelectorAll('.quiz-question');
                questions.forEach(q => {
                    const selectedOption = q.querySelector('.quiz-option.selected');
                    const correctAnswer = q.dataset.correctAnswer;
                    q.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.disabled = true;
                        if (opt.textContent === correctAnswer) {
                            opt.classList.add('correct');
                        }
                    });
                    if (selectedOption) {
                        if (selectedOption.textContent === correctAnswer) {
                            score++;
                        } else {
                            selectedOption.classList.add('incorrect');
                        }
                    }
                });
                const resultsEl = document.getElementById('quiz-results');
                resultsEl.textContent = `You scored ${score} out of ${questions.length}!`;
                submitBtn.style.display = 'none';
            }

            const submitInterestQuizBtn = event.target.closest('#submit-interest-quiz-btn');
            if (submitInterestQuizBtn) {
                const answers = [];
                const questions = featureModalContent.querySelectorAll('.quiz-question');
                let allAnswered = true;
                questions.forEach((q, index) => {
                    const selectedOption = q.querySelector('.quiz-option.selected');
                    if (selectedOption) {
                        answers.push({ question: q.querySelector('p').textContent, answer: selectedOption.textContent });
                    } else {
                        allAnswered = false;
                    }
                });

                if (allAnswered) {
                    fetchInterestSuggestion(answers);
                    submitInterestQuizBtn.disabled = true;
                } else {
                    const resultsArea = document.getElementById('interest-quiz-results-area');
                    resultsArea.innerHTML = `<p class="text-red-400 text-center">Please answer all questions before submitting.</p>`;
                }
                return;
            }

            const flashcard = event.target.closest('.flashcard');
            if(flashcard) {
                flashcard.classList.toggle('is-flipped');
            }
        });


    </script>
</body>
</html>
